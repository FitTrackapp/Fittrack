<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2D3748">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FitTrack">
    <title>FitTrack - Your Fitness Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { overflow-y: scroll; } body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #1f2937; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; } ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .content-section { background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease, opacity 0.3s ease, border-color 0.3s ease; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border: 1px solid transparent; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; } .btn-login { background-color: #374151; color: white; border-color: #1f2937;} .btn-login:hover { background-color: #1f2937; }
        .btn-primary-app { background-color: #4b5563; color: white; border-color: #374151;} .btn-primary-app:hover:not(:disabled) { background-color: #374151; }
        .btn-success-app { background-color: #16a34a; color: white; border-color: #15803d;} .btn-success-app:hover:not(:disabled) { background-color: #15803d; }
        .btn-danger-app { background-color: #dc2626; color: white; border-color: #b91c1c;} .btn-danger-app:hover:not(:disabled) { background-color: #b91c1c; }
        .btn-warning-app { background-color: #f59e0b; color: black; border-color: #d97706;} .btn-warning-app:hover:not(:disabled) { background-color: #d97706; }
        .btn-small { padding: 0.25rem 0.75rem; font-size: 0.875rem; } .btn-icon { padding: 0.5rem; line-height: 1; } .btn-text-icon { padding: 0.6rem 1rem; }
        .btn-toggle { background-color: #e5e7eb; color: #374151; border-color: #d1d5db; margin-bottom: 0.5rem; } .btn-toggle.active { background-color: #374151; color: white; border-color: #1f2937; box-shadow: 0 2px 4px 0 rgba(0,0,0,0.1); } .btn-toggle:hover:not(:disabled):not(.active) { background-color: #d1d5db; }
        .accordion-item { overflow: hidden; } .accordion-button { background-color: #f9fafb; color: #1f2937; } .accordion-button:hover { background-color: #f3f4f6; } .accordion-button svg { transition: transform 0.3s ease; color: #4b5563; } .accordion-button.open svg { transform: rotate(180deg); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.35s ease-in-out, padding-top 0.35s ease-in-out, padding-bottom 0.35s ease-in-out; padding-top: 0; padding-bottom: 0; background-color: #f9fafb; } .accordion-content.open { padding-top: 1rem; padding-bottom: 1rem; }
        .truly-hidden { display: none !important; } .section-hidden { display: none !important; } #appContainer { padding-top: constant(safe-area-inset-top); padding-top: env(safe-area-inset-top); }
        .number-input-slick, .select-slick { background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); padding: 0.5rem 0.75rem; width: 100%; color: #1f2937; } .number-input-slick:focus, .select-slick:focus { outline: none; border-color: #4b5563; box-shadow: 0 0 0 3px rgba(75, 85, 99, 0.2); }
        #settingsTimerMinutes, #settingsTimerSeconds { color: #1f2937; }
        #fullscreenTimerOverlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(31, 41, 55, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; } #fullscreenTimerOverlay.visible { opacity: 1; pointer-events: auto; } #fullscreenTimerOverlay #timerDisplayFullscreen { font-size: 6rem; font-weight: bold; color: white; margin-bottom: 1.5rem; } #fullscreenTimerControls { display: flex; gap: 0.75rem; align-items: center; }
        #mainAppContentWrapper.hidden-for-timer { opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        #settingsModal, #cancelDayConfirmationModal, #workoutSummaryModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(55, 65, 81, 0.6); display: flex; align-items: center; justify-content: center; z-index: 150; padding: 1rem; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; } #settingsModal.visible, #cancelDayConfirmationModal.visible, #workoutSummaryModal.visible { opacity: 1; pointer-events: auto; } #settingsModalContent, #cancelDayConfirmationModalContent, #workoutSummaryModalContent { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); width: 100%; max-width: 28rem; border: 1px solid #d1d5db; }
        #minimizedTimerBar { background-color: #475569; color: white; padding: 0.5rem 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: background-color 0.2s ease-in-out, opacity 0.3s ease-in-out; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; } #minimizedTimerBar.times-up-flash { background-color: #16a34a; color: white; } #minimizedTimerBarText { font-weight: 600; } #minimizedTimerControls button { background: none; border: none; color: white; padding: 0.25rem; } #minimizedTimerControls button.btn-primary-app, #minimizedTimerControls button.btn-warning-app { color: white; } #minimizedTimerControls button.btn-warning-app { color: black; } #minimizedTimerControls button:hover { color: #d1d5db; }
        .calendar-day { padding: 0.5rem; font-size: 0.8rem; border: 1px solid #e0e0e0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); background-color: #f9fafb; } .calendar-day-name { font-size: 0.65rem; } .calendar-day-date { font-size: 1rem; margin-top: 0.1rem; } .calendar-routine-name { font-size: 0.7rem; min-height: 2rem; line-height: 1.2; margin-top: 0.25rem; } .calendar-day .completion-checkbox { margin-top: 0.25rem; transform: scale(0.9); } .calendar-day label[for^="calDone-"] { font-size: 0.65rem; margin-left: 0.1rem; } .calendar-day .mt-2.flex.items-center.justify-center { margin-top: 0.25rem; }
        .calendar-day.completed { background-color: #d1fae5; border-color: #a1eec6; box-shadow: 0 1px 3px rgba(22, 163, 74, 0.1); } .calendar-day.rest-day .calendar-routine-name { color: #6b7280; font-style: italic; }
        #currentDayInfo, #activeExerciseNameDisplay, #activeExerciseTargetsDisplay, #currentExerciseInDayDisplay, #workoutDurationDisplay, label, #activeSetDisplay, #routinesAccordion > p, #loggedWorkoutsAccordion > p, #bodyWeightLogList > p, #consistencyTrackerWrapper h3, #consistencyTracker p, #personalBestsListEl h4, #muscleGroupFocus h3, #muscleGroupPbsListEl h5, #settingsModalContent h2, #settingsModalContent h3, #settingsModalContent p, #resetConfirmationArea p, #cancelDayConfirmationModalContent h2, #cancelDayConfirmationModalContent p, #workoutSummaryModalContent h2, #workoutSummaryModalContent p, #summaryModalBody span { color: #1f2937; }
        #personalBestsList > p, #muscleGroupPbsList > p { color: #6b7280; font-style: italic; } #settingsModalContent .pt-6 { color: #6b7280; } footer { color: #6b7280; }
        #settingsCogButton { color: #d1d5db; } #settingsCogButton:hover { color: white; } #closeSettingsModalBtn, #closeSummaryModalBtn { color: #9ca3af; } #closeSettingsModalBtn:hover, #closeSummaryModalBtn:hover { color: #4b5563; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loginScreen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 p-4">
         <div class="bg-white p-6 sm:p-10 rounded-xl shadow-2xl w-full max-w-sm text-center border border-gray-200">
            <h3 class="text-2xl font-semibold text-gray-700 mb-2">Hello Nathan</h3>
            <p class="text-gray-500 mb-8">Welcome back!</p>
            <input type="password" id="passwordInput" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-6 focus:outline-none focus:ring-2 focus:ring-gray-500 text-lg text-center shadow-sm">
            <button id="loginButton" class="btn btn-login w-full py-3 text-lg">Login</button>
            <p id="loginFeedback" class="text-red-500 text-sm mt-4 h-5"></p>
        </div>
    </div>

    <div id="appContainer" class="truly-hidden">
        <div id="mainAppContentWrapper">
             <header id="appHeader" class="bg-gray-800 text-white p-4 sm:p-6 shadow-lg">
                 <div class="container mx-auto max-w-4xl flex justify-between items-center">
                    <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">FitTrack</h1>
                    <button id="settingsCogButton" class="p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 sm:h-8 sm:w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    </button>
                </div>
             </header>
             <div id="currentDayInfo" class="container mx-auto max-w-4xl p-4 md:px-6 text-center text-sm text-gray-600 font-medium"></div>
             <div id="viewToggleButtons" class="container mx-auto max-w-4xl px-4 md:px-6 flex flex-wrap justify-center space-x-2 sm:space-x-4 mb-2">
                  <button id="showRoutinesBtn" class="btn btn-toggle active">Show Routines</button>
                  <button id="showLogBtn" class="btn btn-toggle">Show Logged Workouts</button>
                  <button id="showCalendarBtn" class="btn btn-toggle">Calendar</button>
                  <button id="showBodyWeightBtn" class="btn btn-toggle">Body Weight</button>
                  <button id="progressBtn" class="btn btn-toggle">Progress</button>
             </div>
             <div id="minimizedTimerBar" class="container mx-auto max-w-4xl truly-hidden rounded-md">
                 <span id="minimizedTimerBarText">Rest Time: 00:00</span>
                 <div id="minimizedTimerControls" class="flex items-center space-x-2"><button id="minimizedPauseResumeBtn" title="Pause/Resume" class="btn btn-icon"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" id="minimizedPlayIconPath"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"  /></svg><svg class="w-5 h-5 truly-hidden" fill="currentColor" viewBox="0 0 20 20" id="minimizedPauseIconPath"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v4a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button><button id="minimizedAdd15sBtn" title="+15 Seconds" class="btn btn-primary-app btn-text-icon text-xs px-2 py-1 font-semibold">+15s</button><button id="minimizedStopBtn" title="Stop Rest" class="btn btn-icon btn-danger-app"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg></button><button id="minimizedMaximizeBtn" title="Maximize Timer" class="btn btn-icon btn-primary-app"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11l7-7 7 7M5 19l7-7 7 7"></path></svg></button></div>
             </div>

            <main class="container mx-auto max-w-4xl p-4 md:p-6 pt-0 md:pt-0 space-y-8">
                <section id="activeWorkoutSection" class="content-section p-6 md:p-8 truly-hidden">
                     <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-gray-900">Active Workout</h2><button id="showCancelDayConfirmationBtn" class="btn btn-danger-app btn-small py-1 px-2">Cancel Day</button></div>
                     <div id="activeExerciseInfo" class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200"><h3 id="activeExerciseNameDisplay" class="text-xl font-semibold text-gray-800">Exercise Name</h3><p id="activeExerciseTargetsDisplay" class="text-sm text-gray-600">Target: X sets of Y reps</p><p id="currentExerciseInDayDisplay" class="text-xs text-gray-500 mt-1">Exercise X of Y for the day</p><p id="workoutDurationDisplay" class="text-sm text-gray-600 mt-1 font-medium">Session Duration: 00:00</p></div>
                     <div class="space-y-4"><div><label for="activeWorkoutDate" class="block text-sm font-medium text-gray-700">Workout Date</label><input type="date" id="activeWorkoutDate" name="activeWorkoutDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500 sm:text-sm text-gray-800"></div><div id="weightInputGroup"><label for="activeWeightInput" class="block text-sm font-medium text-gray-700 mb-1">Weight (<span id="activeUnitDisplayValue" class="text-gray-700">kg</span>)</label><input type="number" id="activeWeightInput" inputmode="decimal" min="0" step="0.1" value="0" class="number-input-slick mt-1"></div><div id="unitInputGroup"><label for="activeUnitInput" class="block text-sm font-medium text-gray-700">Unit</label><select id="activeUnitInput" class="select-slick mt-1"><option value="kg">kg</option><option value="lbs">lbs</option></select></div><div id="durationInputGroup" class="truly-hidden"><label for="activeDurationInput" id="activeDurationLabel" class="block text-sm font-medium text-gray-700 mb-1">Duration (seconds)</label><input type="number" id="activeDurationInput" inputmode="numeric" min="1" step="1" value="30" class="number-input-slick mt-1"></div><div id="rpeInputGroup" class="truly-hidden"><label for="activeRpeSelect" class="block text-sm font-medium text-gray-700">Perceived Exertion (RPE)</label><select id="activeRpeSelect" class="select-slick mt-1"><option value="">- Select RPE -</option><option value="Easy">Easy</option><option value="Medium">Medium</option><option value="Hard">Hard</option><option value="Extreme">Extreme</option></select></div><p id="activeSetDisplay" class="text-md font-medium text-gray-700 text-center my-2">Set: 1 / 3</p><div><label for="activeNotesInput" class="block text-sm font-medium text-gray-700">Notes (optional)</label><textarea id="activeNotesInput" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500 sm:text-sm text-gray-800" placeholder="e.g., Felt strong, focus on form..."></textarea></div><div class="flex space-x-3 mt-6"><button id="logSetButton" class="flex-1 btn btn-primary-app font-semibold py-2 px-4 rounded-md shadow-md">Log Set & Rest</button><button id="finishExerciseButton" class="flex-1 btn btn-success-app font-semibold py-2 px-4 rounded-md shadow-md">Finish Exercise & Next</button></div></div>
                     <div id="activeWorkoutFeedback" class="mt-4 text-sm h-5"></div>
                </section>

                <section id="workout-routines-section" class="content-section p-6 md:p-8">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-900">Workout Routines</h2>
                    <div id="routinesAccordion" class="space-y-3"><p class="text-gray-500 italic">Loading routines...</p></div>
                </section>

                <section id="calendar-section" class="content-section p-6 md:p-8 section-hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-900">Weekly Schedule</h2>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
                    <p class="text-xs text-gray-500 mt-4 italic">This calendar shows your scheduled routines...</p>
                </section>

                <section id="workout-list-section" class="content-section p-6 md:p-8 section-hidden">
                     <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-semibold text-gray-900">Logged Workouts</h2></div>
                     <div id="loggedWorkoutsAccordion" class="space-y-3"><p class="text-gray-500 italic">No workouts logged yet.</p></div>
                </section>

                <section id="body-weight-section" class="content-section p-6 md:p-8 section-hidden">
                     <h2 class="text-2xl font-semibold mb-6 text-gray-900">Body Weight Log</h2>
                     <form id="bodyWeightForm" class="space-y-4 mb-8"><div class="grid grid-cols-1 sm:grid-cols-3 gap-4"><div><label for="bodyWeightInput" class="block text-sm font-medium text-gray-700">Weight</label><input type="number" id="bodyWeightInput" inputmode="decimal" step="0.1" required class="number-input-slick mt-1"></div><div><label for="bodyWeightUnit" class="block text-sm font-medium text-gray-700">Unit</label><select id="bodyWeightUnit" class="select-slick mt-1"><option value="kg">kg</option><option value="lbs">lbs</option></select></div><div><label for="bodyWeightDate" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="bodyWeightDate" required class="number-input-slick mt-1"></div></div><button type="submit" class="btn btn-primary-app w-full sm:w-auto">Log Body Weight</button></form>
                     <div id="bodyWeightLogList" class="space-y-3"><p class="text-gray-500 italic">No body weight logged yet.</p></div>
                     <p id="bodyWeightFeedback" class="mt-4 text-sm h-5"></p>
                </section>

                <section id="progress-section" class="content-section p-6 md:p-8 section-hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-900">Progress</h2>
                    <div id="consistencyTrackerWrapper" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm"><h3 class="text-lg font-semibold text-gray-800 mb-2">Workout Consistency</h3><div id="consistencyTracker" class=""><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center"><div><p class="text-2xl font-bold text-gray-700" id="currentStreakDisplay">0</p><p class="text-xs text-gray-500">Current Streak (Days)</p></div><div><p class="text-2xl font-bold text-gray-700" id="workoutsThisWeekDisplay">0</p><p class="text-xs text-gray-500">Workouts This Week</p></div><div><p class="text-2xl font-bold text-gray-700" id="longestStreakDisplay">0</p><p class="text-xs text-gray-500">Longest Streak (Days)</p></div></div></div><p id="motivationalMessage" class="text-sm text-center text-gray-600 mt-4 italic"></p></div>
                     <div class="accordion-item mb-6 border border-gray-200 rounded-lg shadow-sm"><button id="togglePBsBtn" class="accordion-button w-full flex justify-between items-center p-4 text-left"><span class="font-medium">Personal Bests (PBs)</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="personalBestsList" class="accordion-content p-4 space-y-4"><p class="text-gray-500 italic">No workouts logged yet.</p></div></div>
                     <div class="accordion-item border border-gray-200 rounded-lg shadow-sm"><button id="toggleMuscleFocusBtn" class="accordion-button w-full flex justify-between items-center p-4 text-left"><span class="font-medium">Muscle Group Focus (Based on PBs)</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="muscleGroupPbsList" class="accordion-content p-4 space-y-4"><p class="text-gray-500 italic">Log workouts to see.</p></div></div>
                </section>
            </main>

            <footer class="text-center p-6 mt-10 text-gray-600 text-sm">
                <p>&copy; <span id="currentYear"></span> FitTrack. Keep Pushing!</p>
            </footer>
        </div>
    </div>

    <div id="settingsModal" class="truly-hidden">
        <div id="settingsModalContent">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-900">Settings</h2>
                <button id="closeSettingsModalBtn"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Timer Settings</h3>
                <p class="text-sm text-gray-600 mb-4">Set your default rest period duration.</p>
                <div class="space-y-4">
                    <div class="flex items-center space-x-3">
                        <div class="flex-1"><label for="settingsTimerMinutes" class="block text-sm font-medium text-gray-700">Minutes</label><input type="number" id="settingsTimerMinutes" min="0" max="59" class="number-input-slick mt-1 text-center"></div>
                        <span class="pt-6 text-xl font-semibold text-gray-500">:</span>
                        <div class="flex-1"><label for="settingsTimerSeconds" class="block text-sm font-medium text-gray-700">Seconds</label><input type="number" id="settingsTimerSeconds" min="0" max="59" class="number-input-slick mt-1 text-center"></div>
                    </div>
                    <button id="saveTimerSettingsBtn" class="btn btn-primary-app w-full py-2.5">Save Timer Settings</button>
                </div>
            </div>
            <hr class="my-6 border-gray-200">
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Data Management</h3>
                <button id="exportDataBtn" class="btn btn-primary-app w-full py-2.5 mb-3">Export All App Data</button>
                <div>
                    <label for="importFile" class="block text-sm font-medium text-gray-700 mb-1">Import App Data (.json)</label>
                    <input type="file" id="importFile" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300 cursor-pointer"/>
                    <button id="importDataBtn" class="btn btn-primary-app w-full py-2.5 mt-2">Import Selected File</button>
                </div>
            </div>
            <hr class="my-6 border-gray-200">
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Reset App Data</h3>
                <p class="text-sm text-gray-600 mb-3">This will delete all logged workouts and reset timer settings to default.</p>
                <button id="showResetConfirmationBtn" class="btn btn-danger-app w-full py-2.5">Reset All App Data</button>
                <div id="resetConfirmationArea" class="mt-3 p-3 bg-red-50 border border-red-200 rounded-md truly-hidden">
                    <p class="text-sm text-red-700 mb-3">Are you sure? This action cannot be undone.</p>
                    <div class="flex space-x-3"><button id="confirmResetBtn" class="btn btn-danger-app flex-1">Yes, Reset Data</button><button id="cancelResetBtn" class="btn btn-primary-app flex-1">No, Cancel</button></div>
                </div>
            </div>
            <p id="settingsFeedback" class="text-sm mt-4 h-5"></p>
        </div>
    </div>
    <div id="cancelDayConfirmationModal" class="truly-hidden"><div id="cancelDayConfirmationModalContent"><h2 class="text-xl font-semibold text-gray-900 mb-4">Cancel Workout Day?</h2><p class="text-sm text-gray-600 mb-6">Are you sure you want to cancel the current workout day? Any unsaved progress for the current exercise will be lost.</p><div class="flex justify-end space-x-3"><button id="confirmCancelDayBtn" class="btn btn-danger-app">Yes, Cancel Day</button><button id="dontCancelDayBtn" class="btn btn-primary-app">No, Continue</button></div></div></div>
    <div id="workoutSummaryModal" class="truly-hidden"><div id="workoutSummaryModalContent"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-gray-900" id="summaryModalTitle">Workout Completed!</h2><button id="closeSummaryModalBtn"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div id="summaryModalBody" class="text-sm text-gray-600 space-y-2"><p>Total Exercises: <span id="summaryTotalExercises" class="font-medium text-gray-700">0</span></p><p>Total Sets Logged: <span id="summaryTotalSets" class="font-medium text-gray-700">0</span></p><p>Session Duration: <span id="summarySessionDuration" class="font-medium text-gray-700">00:00</span></p><p class="mt-4 font-semibold text-green-600">Great work, Nathan! Keep it up!</p></div><div class="mt-6 flex justify-end"><button id="okSummaryModalBtn" class="btn btn-success-app">Great!</button></div></div></div>
    <div id="fullscreenTimerOverlay" class="truly-hidden"><div id="timerDisplayFullscreen" class="text-7xl sm:text-8xl font-bold text-white">00:00</div><div id="fullscreenTimerControls" class="mt-6"><button id="fullscreenPauseResumeBtn" class="btn btn-icon p-3"><svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20" id="fullscreenPlayIcon"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg><svg class="w-7 h-7 truly-hidden" fill="currentColor" viewBox="0 0 20 20" id="fullscreenPauseIcon"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v4a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button><button id="fullscreenAdd15sBtn" class="btn btn-primary-app btn-text-icon font-semibold p-3" title="+15 Seconds">+15s</button><button id="fullscreenStopBtn" class="btn btn-danger-app btn-icon p-3" title="Stop Rest & Workout"><svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg></button><button id="fullscreenMinimizeBtn" class="btn btn-primary-app btn-icon p-3" title="Minimize Timer"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 13l-7 7-7-7m14-4l-7 7-7-7" /></svg></button></div></div>

    <script>
        console.log("FitTrack Script: Starting execution.");
        document.addEventListener('DOMContentLoaded', () => {
            console.log("FitTrack Script: DOMContentLoaded event fired.");
            try {
                // --- DOM Elements ---
                const loginScreen = document.getElementById('loginScreen');
                const appContainer = document.getElementById('appContainer');
                const mainAppContentWrapper = document.getElementById('mainAppContentWrapper');
                const appHeader = document.getElementById('appHeader');
                const passwordInput = document.getElementById('passwordInput');
                const loginButton = document.getElementById('loginButton');
                const loginFeedback = document.getElementById('loginFeedback');
                const currentDayInfo = document.getElementById('currentDayInfo');
                const routinesAccordionEl = document.getElementById('routinesAccordion');
                const calendarGridEl = document.getElementById('calendarGrid');
                const calendarSection = document.getElementById('calendar-section');
                const loggedWorkoutsAccordionEl = document.getElementById('loggedWorkoutsAccordion');
                const activeWorkoutSection = document.getElementById('activeWorkoutSection');
                const activeExerciseNameDisplay = document.getElementById('activeExerciseNameDisplay');
                const activeExerciseTargetsDisplay = document.getElementById('activeExerciseTargetsDisplay');
                const currentExerciseInDayDisplay = document.getElementById('currentExerciseInDayDisplay');
                const activeWorkoutDateInput = document.getElementById('activeWorkoutDate');
                const workoutDurationDisplay = document.getElementById('workoutDurationDisplay');
                const activeWeightInput = document.getElementById('activeWeightInput');
                const activeWeightInputGroup = document.getElementById('weightInputGroup');
                const activeDurationInputGroup = document.getElementById('durationInputGroup');
                const activeDurationInput = document.getElementById('activeDurationInput');
                const activeDurationLabel = document.getElementById('activeDurationLabel');
                const activeUnitDisplayValue = document.getElementById('activeUnitDisplayValue');
                const activeUnitInput = document.getElementById('activeUnitInput');
                const unitInputGroup = document.getElementById('unitInputGroup');
                const rpeInputGroup = document.getElementById('rpeInputGroup');
                const activeRpeSelect = document.getElementById('activeRpeSelect');
                const activeSetDisplay = document.getElementById('activeSetDisplay');
                const activeNotesInput = document.getElementById('activeNotesInput');
                const logSetButton = document.getElementById('logSetButton');
                const finishExerciseButton = document.getElementById('finishExerciseButton');
                const showCancelDayConfirmationBtn = document.getElementById('showCancelDayConfirmationBtn');
                const activeWorkoutFeedback = document.getElementById('activeWorkoutFeedback');
                const settingsCogButton = document.getElementById('settingsCogButton');
                const settingsModal = document.getElementById('settingsModal');
                const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
                const settingsTimerMinutesInput = document.getElementById('settingsTimerMinutes');
                const settingsTimerSecondsInput = document.getElementById('settingsTimerSeconds');
                const saveTimerSettingsBtn = document.getElementById('saveTimerSettingsBtn');
                const settingsFeedback = document.getElementById('settingsFeedback');
                const showResetConfirmationBtn = document.getElementById('showResetConfirmationBtn');
                const resetConfirmationArea = document.getElementById('resetConfirmationArea');
                const confirmResetBtn = document.getElementById('confirmResetBtn');
                const cancelResetBtn = document.getElementById('cancelResetBtn');
                const exportDataBtn = document.getElementById('exportDataBtn');
                const importFileEl = document.getElementById('importFile');
                const importDataBtn = document.getElementById('importDataBtn');
                const cancelDayConfirmationModal = document.getElementById('cancelDayConfirmationModal');
                const confirmCancelDayBtn = document.getElementById('confirmCancelDayBtn');
                const dontCancelDayBtn = document.getElementById('dontCancelDayBtn');
                const workoutSummaryModal = document.getElementById('workoutSummaryModal');
                const summaryModalTitle = document.getElementById('summaryModalTitle');
                const summaryTotalExercises = document.getElementById('summaryTotalExercises');
                const summaryTotalSets = document.getElementById('summaryTotalSets');
                const summarySessionDuration = document.getElementById('summarySessionDuration');
                const okSummaryModalBtn = document.getElementById('okSummaryModalBtn');
                const closeSummaryModalBtn = document.getElementById('closeSummaryModalBtn');
                const fullscreenTimerOverlay = document.getElementById('fullscreenTimerOverlay');
                const timerDisplayFullscreen = document.getElementById('timerDisplayFullscreen');
                const fullscreenPauseResumeBtn = document.getElementById('fullscreenPauseResumeBtn');
                const fullscreenPlayIcon = document.getElementById('fullscreenPlayIcon');
                const fullscreenPauseIcon = document.getElementById('fullscreenPauseIcon');
                const fullscreenAdd15sBtn = document.getElementById('fullscreenAdd15sBtn');
                const fullscreenStopBtn = document.getElementById('fullscreenStopBtn');
                const fullscreenMinimizeBtn = document.getElementById('fullscreenMinimizeBtn');
                const minimizedTimerBar = document.getElementById('minimizedTimerBar');
                const minimizedTimerBarText = document.getElementById('minimizedTimerBarText');
                const minimizedPauseResumeBtn = document.getElementById('minimizedPauseResumeBtn');
                const minimizedPlayIconPath = document.getElementById('minimizedPlayIconPath');
                const minimizedPauseIconPath = document.getElementById('minimizedPauseIconPath');
                const minimizedAdd15sBtn = document.getElementById('minimizedAdd15sBtn');
                const minimizedStopBtn = document.getElementById('minimizedStopBtn');
                const minimizedMaximizeBtn = document.getElementById('minimizedMaximizeBtn');
                const viewToggleButtons = document.getElementById('viewToggleButtons');
                const showRoutinesBtn = document.getElementById('showRoutinesBtn');
                const showLogBtn = document.getElementById('showLogBtn');
                const showCalendarBtn = document.getElementById('showCalendarBtn');
                const progressBtn = document.getElementById('progressBtn');
                const showBodyWeightBtn = document.getElementById('showBodyWeightBtn');
                const workoutRoutinesSection = document.getElementById('workout-routines-section');
                const workoutListSection = document.getElementById('workout-list-section');
                const bodyWeightSection = document.getElementById('body-weight-section');
                const bodyWeightForm = document.getElementById('bodyWeightForm');
                const bodyWeightInputEl = document.getElementById('bodyWeightInput');
                const bodyWeightUnitEl = document.getElementById('bodyWeightUnit');
                const bodyWeightDateEl = document.getElementById('bodyWeightDate');
                const bodyWeightLogList = document.getElementById('bodyWeightLogList');
                const bodyWeightFeedback = document.getElementById('bodyWeightFeedback');
                const progressSection = document.getElementById('progress-section');
                const personalBestsListEl = document.getElementById('personalBestsList');
                const muscleGroupPbsListEl = document.getElementById('muscleGroupPbsList');
                const currentStreakDisplay = document.getElementById('currentStreakDisplay');
                const workoutsThisWeekDisplay = document.getElementById('workoutsThisWeekDisplay');
                const longestStreakDisplay = document.getElementById('longestStreakDisplay');
                const motivationalMessageEl = document.getElementById('motivationalMessage');
                const togglePBsBtn = document.getElementById('togglePBsBtn');
                const toggleMuscleFocusBtn = document.getElementById('toggleMuscleFocusBtn');

                // --- App State ---
                let activeWorkoutState = null; let currentDayRoutine = null; let currentExerciseIndex = -1;
                let defaultRestMinutes = 1; let defaultRestSeconds = 30;
                let workoutSessionStartTime = null; let workoutDurationInterval = null; let totalSetsThisSession = 0;
                let timerInterval; let remainingSecondsForCountdown = 0; let restTimerState = 'idle'; let isTimerMinimized = false;

                // --- Workout Routines Data ---
                const workoutRoutinesData = [
                    { day: "Day 1: Chest & Triceps", exercises: [ { name: "Barbell Bench Press (or dumbbell)", sets: 3, reps: "10-12", why: "Primary chest builder...", muscleGroup: "Chest", type: "weight" }, { name: "Incline Dumbbell Press", sets: 3, reps: "10-12", why: "Targets upper chest...", muscleGroup: "Chest", type: "weight" }, { name: "Dumbbell Flyes (or band chest fly)", sets: 2, reps: "12-15", why: "Isolates chest muscles...", muscleGroup: "Chest", type: "weight" }, { name: "Overhead Tricep Extension (dumbbell/band)", sets: 3, reps: "12", why: "Works all three heads of triceps...", muscleGroup: "Triceps", type: "weight" }, { name: "Tricep Dips (bench/parallel bars)", sets: 2, reps: "10-12", why: "Compound tricep movement...", muscleGroup: "Triceps", type: "weight" } ]},
                    { day: "Day 2: Back & Biceps", exercises: [ { name: "Bent-Over Dumbbell Row", sets: 3, reps: "10-12", why: "Builds back thickness...", muscleGroup: "Back", type: "weight" }, { name: "Assisted Pull-Ups (or inverted rows)", sets: 3, reps: "8-10", why: "Excellent for back width...", muscleGroup: "Back", type: "weight" }, { name: "Lat Pulldown (or extra dumbbell row)", sets: 3, reps: "10-12", why: "Mimics pull-ups...", muscleGroup: "Back", type: "weight" }, { name: "Dumbbell Bicep Curl", sets: 3, reps: "12", why: "Classic bicep builder...", muscleGroup: "Biceps", type: "weight" }, { name: "Hammer Curls (dumbbells/bands)", sets: 2, reps: "12-15", why: "Targets brachialis...", muscleGroup: "Biceps", type: "weight" } ]},
                    { day: "Day 3: Legs & Glutes", exercises: [ { name: "Leg Press (machine or dumbbell sumo squat)", sets: 3, reps: "10-12", why: "Targets quads, glutes...", muscleGroup: "Legs", type: "weight" }, { name: "Seated Leg Curl (machine or dumbbell stiff-leg deadlift)", sets: 3, reps: "12", why: "Focuses on hamstrings...", muscleGroup: "Hamstrings", type: "weight" }, { name: "Leg Extension (machine or bodyweight step-ups)", sets: 3, reps: "10-12", why: "Isolates quads...", muscleGroup: "Quads", type: "weight" }, { name: "Hip Thrust (barbell or dumbbell)", sets: 3, reps: "12-15", why: "Glute-focused...", muscleGroup: "Glutes", type: "weight" }, { name: "Seated Calf Raise (machine or dumbbell)", sets: 2, reps: "15-20", why: "Isolates calves...", muscleGroup: "Calves", type: "weight" } ]},
                    { day: "Day 4: Shoulders & Core", exercises: [ { name: "Seated Dumbbell Shoulder Press", sets: 3, reps: "10-12", why: "Builds shoulder mass...", muscleGroup: "Shoulders", type: "weight" }, { name: "Lateral Raises (dumbbells/bands)", sets: 3, reps: "12-15", why: "Isolates medial deltoids...", muscleGroup: "Shoulders", type: "weight" }, { name: "Front Raises (dumbbells/bands)", sets: 2, reps: "12", why: "Targets anterior deltoids...", muscleGroup: "Shoulders", type: "weight" }, { name: "Plank", sets: 3, reps: "20-30 sec", why: "Core stability... Reps = seconds for timed.", muscleGroup: "Core", type: "timed" }, { name: "Russian Twists (with/without weight)", sets: 3, reps: "15 reps/side", why: "Targets obliques...", muscleGroup: "Core", type: "weight" } ]},
                    { day: "Day 5: Full-Body", exercises: [ { name: "Bodyweight Squats", sets: 3, reps: "12-15", why: "Fundamental compound movement...", muscleGroup: "Legs", type: "weight" }, { name: "Barbell Bench Press (or dumbbell)", sets: 3, reps: "10-12", why: "Primary chest builder...", muscleGroup: "Chest", type: "weight" }, { name: "Single-Arm Dumbbell Row", sets: 3, reps: "10 reps/arm", why: "Unilateral back exercise...", muscleGroup: "Back", type: "weight" }, { name: "Dumbbell Shoulder Press", sets: 2, reps: "10-12", why: "Compound shoulder exercise...", muscleGroup: "Shoulders", type: "weight" }, { name: "Bicycle Crunches", sets: 3, reps: "15 reps/side", why: "Effective core exercise...", muscleGroup: "Core", type: "reps" } ]}
                ];

                // --- Utility Functions ---
                function showUserFeedback(element, message, type, duration = 3000) { if (!element) { console.warn("showUserFeedback: Target element not found for message:", message); return; } element.textContent = message; element.className = `text-sm mt-4 ${type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-500' : 'text-gray-600'}`; if (duration > 0) { setTimeout(() => { if (element.textContent === message) { element.textContent = ''; element.className = 'text-sm mt-4 h-5'; } }, duration); } }
                function setDefaultDate(dateInputElement) { if (dateInputElement && !dateInputElement.value) { const today = new Date(); const y = today.getFullYear(); const m = String(today.getMonth() + 1).padStart(2, '0'); const d = String(today.getDate()).padStart(2, '0'); dateInputElement.value = `${y}-${m}-${d}`; } }

                // --- Local Storage ---
                function loadWorkouts() { try { return JSON.parse(localStorage.getItem('fitTrackWorkouts') || '[]'); } catch(e) { console.error("Error loading workouts:", e); return []; } }
                function saveWorkouts(workouts) { localStorage.setItem('fitTrackWorkouts', JSON.stringify(workouts)); }
                function loadBodyWeights() { try { return JSON.parse(localStorage.getItem('fitTrackBodyWeights') || '[]'); } catch(e) { console.error("Error loading body weights:", e); return []; } }
                function saveBodyWeights(weights) { localStorage.setItem('fitTrackBodyWeights', JSON.stringify(weights)); }
                function loadCompletedDays() { try { return JSON.parse(localStorage.getItem('fitTrackCompletedDays') || '{}'); } catch(e) { console.error("Error loading completed days:", e); return {}; } }
                function saveCompletedDays(completedDays) { localStorage.setItem('fitTrackCompletedDays', JSON.stringify(completedDays)); }

                // --- Accordion / Rendering Functions ---
                function setupAccordionToggle(buttonEl, contentEl, startOpen = false) { if (!buttonEl || !contentEl) { return; } const svgIcon = buttonEl.querySelector('svg'); function toggle() { const isOpen = contentEl.classList.contains('open'); buttonEl.classList.toggle('open', !isOpen); if (svgIcon) { svgIcon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)'; } if (!isOpen) { contentEl.classList.add('open'); contentEl.style.maxHeight = contentEl.scrollHeight + 'px'; } else { contentEl.style.maxHeight = '0px'; const transitionEndHandler = () => { if (!buttonEl.classList.contains('open')) { contentEl.classList.remove('open'); } contentEl.removeEventListener('transitionend', transitionEndHandler); }; contentEl.addEventListener('transitionend', transitionEndHandler); } } if (startOpen) { buttonEl.classList.add('open'); contentEl.classList.add('open'); if (svgIcon) svgIcon.style.transform = 'rotate(180deg)'; requestAnimationFrame(() => { if (contentEl.classList.contains('open')) { contentEl.style.maxHeight = contentEl.scrollHeight + 'px'; }}); } else { contentEl.style.maxHeight = '0px'; contentEl.classList.remove('open'); if (svgIcon) svgIcon.style.transform = 'rotate(0deg)'; } buttonEl.addEventListener('click', toggle); }
                function renderLoggedWorkoutsAccordion() { if (!loggedWorkoutsAccordionEl) return; const workouts = loadWorkouts(); loggedWorkoutsAccordionEl.innerHTML = ''; if (workouts.length === 0) { loggedWorkoutsAccordionEl.innerHTML = '<p class="text-gray-500 italic">No workouts logged yet.</p>'; return; } const workoutsByDate = workouts.reduce((acc, workout) => { const date = workout.date; if (!acc[date]) acc[date] = []; acc[date].push(workout); return acc; }, {}); const sortedDates = Object.keys(workoutsByDate).sort((a, b) => new Date(b) - new Date(a)); if (sortedDates.length === 0) { loggedWorkoutsAccordionEl.innerHTML = '<p class="text-gray-500 italic">No workouts logged yet.</p>'; return; } sortedDates.forEach(date => { const accordionItem = document.createElement('div'); accordionItem.className = 'accordion-item border border-gray-200 rounded-lg shadow-sm'; const button = document.createElement('button'); button.className = 'accordion-button w-full flex justify-between items-center p-4 text-left'; button.innerHTML = `<span class="font-medium">${new Date(date + 'T00:00:00').toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`; const content = document.createElement('div'); content.className = 'accordion-content'; const workoutListForDate = document.createElement('div'); workoutListForDate.className = 'space-y-3 p-4'; workoutsByDate[date].sort((a,b) => b.id - a.id).forEach(workout => { const workoutItem = document.createElement('div'); workoutItem.className = 'bg-gray-50 p-3 rounded-md border border-gray-100'; let detailsHtml = `<div class="flex justify-between items-start"><h4 class="text-md font-semibold text-gray-700">${workout.exercise}</h4><button onclick="deleteWorkout(${workout.id})" class="btn btn-danger-app btn-small text-xs p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div><div class="mt-1 text-sm text-gray-600 grid grid-cols-2 sm:grid-cols-3 gap-2"><span>S: ${workout.sets}</span>`; if (workout.type === 'timed') { detailsHtml += `<span>Duration: ${workout.reps}</span>`; } else if (workout.type === 'reps') { detailsHtml += `<span>R: ${workout.reps}</span>`; } else { detailsHtml += `<span>R: ${workout.reps}</span> <span>W: ${workout.weight} ${workout.unit}</span>`; } detailsHtml += `</div>`; if (workout.rpe) { detailsHtml += `<p class="text-xs text-gray-500 mt-1">RPE: ${workout.rpe}</p>`; } if(workout.notes) { detailsHtml += `<p class="text-xs text-gray-500 mt-2"><em>Notes: ${workout.notes}</em></p>`; } workoutItem.innerHTML = detailsHtml; workoutListForDate.appendChild(workoutItem); }); content.appendChild(workoutListForDate); accordionItem.appendChild(button); accordionItem.appendChild(content); loggedWorkoutsAccordionEl.appendChild(accordionItem); setupAccordionToggle(button, content); }); }
                window.deleteWorkout = function(workoutId) { let workouts = loadWorkouts(); workouts = workouts.filter(workout => workout.id !== workoutId); saveWorkouts(workouts); renderLoggedWorkoutsAccordion(); renderProgress(); showUserFeedback(activeWorkoutFeedback || settingsFeedback, 'Workout deleted.', 'success'); }

                function renderWorkoutRoutines() {
                    console.log("renderWorkoutRoutines: Starting...");
                    if (!routinesAccordionEl) { console.error("renderWorkoutRoutines: routinesAccordionEl not found!"); return; }
                    routinesAccordionEl.innerHTML = '';
                    if (!workoutRoutinesData || workoutRoutinesData.length === 0) { console.log("renderWorkoutRoutines: No routine data found or data array is invalid."); routinesAccordionEl.innerHTML = '<p class="text-gray-500 italic">No routines defined.</p>'; return; }
                    console.log(`renderWorkoutRoutines: Processing ${workoutRoutinesData.length} routines.`);
                    try {
                        workoutRoutinesData.forEach((routine, dayIdx) => {
                            const accordionItem = document.createElement('div'); accordionItem.className = 'accordion-item border border-gray-200 rounded-lg shadow-sm'; const button = document.createElement('button'); button.className = 'accordion-button w-full flex justify-between items-center p-4 text-left'; button.innerHTML = `<span class="font-medium">${routine.day}</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`; const content = document.createElement('div'); content.className = 'accordion-content'; const startDayBtn = document.createElement('button'); startDayBtn.className = 'btn btn-success-app w-full sm:w-auto my-2 mx-3 sm:mx-4'; startDayBtn.textContent = `Start ${routine.day}`; startDayBtn.onclick = () => startDayRoutine(dayIdx); content.appendChild(startDayBtn); const exerciseList = document.createElement('ul'); exerciseList.className = 'space-y-0 px-3 sm:px-4';
                            if (routine.exercises && routine.exercises.length > 0) { routine.exercises.forEach(exercise => { const listItem = document.createElement('li'); listItem.className = 'py-3 border-t border-gray-200 first:border-t-0'; listItem.innerHTML = `<h4 class="font-semibold text-gray-800">${exercise.name}</h4><p class="text-sm text-gray-600">Sets: ${exercise.sets}, Reps: ${exercise.reps}</p><p class="text-xs text-gray-500 mt-1"><em>Why: ${exercise.why || 'N/A'}</em></p>`; exerciseList.appendChild(listItem); });
                            } else { const noExercisesItem = document.createElement('li'); noExercisesItem.className = 'py-3 text-sm text-gray-500 italic'; noExercisesItem.textContent = 'No exercises defined for this day.'; exerciseList.appendChild(noExercisesItem); }
                            content.appendChild(exerciseList); accordionItem.appendChild(button); accordionItem.appendChild(content); routinesAccordionEl.appendChild(accordionItem); setupAccordionToggle(button, content);
                        });
                    } catch (renderLoopError) { console.error("renderWorkoutRoutines: Error occurred inside forEach loop:", renderLoopError); }
                    console.log("renderWorkoutRoutines: Finished processing routines.");
                }
                function renderWeeklyCalendarView() { if (!calendarGridEl) return; calendarGridEl.innerHTML = ''; const today = new Date(); const currentDayOfWeek = today.getDay(); const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"]; const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - (currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1)); startOfWeek.setHours(0,0,0,0); const completedDays = loadCompletedDays(); const restDayIndices = [0, 3]; for (let i = 0; i < 7; i++) { const dayDate = new Date(startOfWeek); dayDate.setDate(startOfWeek.getDate() + i); const dayOfWeekIndex = dayDate.getDay(); const dateString = `${dayDate.getFullYear()}-${String(dayDate.getMonth() + 1).padStart(2, '0')}-${String(dayDate.getDate()).padStart(2, '0')}`; const dayCell = document.createElement('div'); dayCell.className = 'calendar-day flex flex-col justify-between items-center'; if (completedDays[dateString]) { dayCell.classList.add('completed'); } if (restDayIndices.includes(dayOfWeekIndex)) { dayCell.classList.add('rest-day'); } let routineNameForDay = "Rest Day"; if (!restDayIndices.includes(dayOfWeekIndex)) { if (dayOfWeekIndex === 1 && workoutRoutinesData[0]) routineNameForDay = workoutRoutinesData[0].day.split(':')[1].trim(); else if (dayOfWeekIndex === 2 && workoutRoutinesData[1]) routineNameForDay = workoutRoutinesData[1].day.split(':')[1].trim(); else if (dayOfWeekIndex === 4 && workoutRoutinesData[2]) routineNameForDay = workoutRoutinesData[2].day.split(':')[1].trim(); else if (dayOfWeekIndex === 5 && workoutRoutinesData[3]) routineNameForDay = workoutRoutinesData[3].day.split(':')[1].trim(); else if (dayOfWeekIndex === 6 && workoutRoutinesData[4]) routineNameForDay = workoutRoutinesData[4].day.split(':')[1].trim(); } let dayHtml = `<div class="w-full text-center"><p class="calendar-day-name">${days[dayOfWeekIndex]}</p><p class="calendar-day-date">${dayDate.getDate()}</p></div><p class="calendar-routine-name mt-2 flex-grow flex items-center justify-center text-center">${routineNameForDay}</p>`; if (!restDayIndices.includes(dayOfWeekIndex)) { dayHtml += `<div class="mt-auto flex items-center justify-center pt-1"><input type="checkbox" id="calDone-${dateString}" class="completion-checkbox h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500" onchange="handleMarkDayAsDone('${dateString}', this.checked)" ${completedDays[dateString] ? 'checked' : ''}><label for="calDone-${dateString}" class="ml-2 text-xs text-gray-600">Done</label></div>`; } else { dayHtml += `<div class="h-8"></div>`; } dayCell.innerHTML = dayHtml; calendarGridEl.appendChild(dayCell); } }
                window.handleMarkDayAsDone = function(dateString, isChecked) { const completedDays = loadCompletedDays(); if (isChecked) { completedDays[dateString] = true; } else { delete completedDays[dateString]; } saveCompletedDays(completedDays); renderWeeklyCalendarView(); renderProgress(); }
                function renderBodyWeightLog() { if (!bodyWeightLogList) return; bodyWeightLogList.innerHTML = ''; const bodyWeights = loadBodyWeights(); if (bodyWeights.length === 0) { bodyWeightLogList.innerHTML = '<p class="text-gray-500 italic">No body weight logged yet.</p>'; return; } bodyWeights.sort((a, b) => new Date(b.date) - new Date(a.date)); bodyWeights.forEach(entry => { const item = document.createElement('div'); item.className = 'bg-gray-50 p-3 rounded-md border border-gray-100 flex justify-between items-center'; item.innerHTML = `<div><span class="font-semibold text-gray-800">${entry.weight} ${entry.unit}</span><span class="text-xs text-gray-500 ml-2">(${new Date(entry.date + 'T00:00:00').toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })})</span></div><button onclick="deleteBodyWeightEntry(${entry.id})" class="btn btn-danger-app btn-small text-xs p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button>`; bodyWeightLogList.appendChild(item); }); }
                window.deleteBodyWeightEntry = function(entryId) { let bodyWeights = loadBodyWeights(); bodyWeights = bodyWeights.filter(entry => entry.id !== entryId); saveBodyWeights(bodyWeights); renderBodyWeightLog(); if (bodyWeightFeedback) showUserFeedback(bodyWeightFeedback, 'Body weight entry deleted.', 'success'); }
                function renderProgress() { if (!personalBestsListEl || !muscleGroupPbsListEl || !currentStreakDisplay || !workoutsThisWeekDisplay || !longestStreakDisplay || !motivationalMessageEl) { return; } const workouts = loadWorkouts(); const completedDays = loadCompletedDays(); personalBestsListEl.innerHTML = ''; muscleGroupPbsListEl.innerHTML = ''; const completedDates = Object.keys(completedDays).filter(dateStr => completedDays[dateStr]).sort((a, b) => new Date(a) - new Date(b)); let currentS = 0; let longestS = 0; let workoutsThisW = 0; const restDayIndices = [0, 3]; if (completedDates.length > 0) { let today = new Date(); today.setHours(0, 0, 0, 0); let streakDate = new Date(today); for (let i = 0; i < 365; i++) { const dateString = streakDate.toISOString().split('T')[0]; const dayOfWeek = streakDate.getDay(); if (completedDays[dateString]) { currentS++; } else if (!restDayIndices.includes(dayOfWeek)) { break; } streakDate.setDate(streakDate.getDate() - 1); } let currentSequence = 0; const firstWorkoutDate = new Date(completedDates[0] + 'T00:00:00'); const lastCompletedDateConsideredForLongestStreak = new Date(completedDates[completedDates.length - 1] + 'T00:00:00'); let tempDate = new Date(firstWorkoutDate); while(tempDate <= lastCompletedDateConsideredForLongestStreak) { const dateStr = tempDate.toISOString().split('T')[0]; const dayOfWeek = tempDate.getDay(); if (completedDays[dateStr]) { currentSequence++; } else if (!restDayIndices.includes(dayOfWeek)) { longestS = Math.max(longestS, currentSequence); currentSequence = 0; } tempDate.setDate(tempDate.getDate() + 1); } longestS = Math.max(longestS, currentSequence); const todayForWeek = new Date(); const dayOfWeekForWeek = todayForWeek.getDay(); const startOfWeekOffset = dayOfWeekForWeek === 0 ? -6 : 1 - dayOfWeekForWeek; const startOfWeek = new Date(todayForWeek); startOfWeek.setDate(todayForWeek.getDate() + startOfWeekOffset); startOfWeek.setHours(0, 0, 0, 0); const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate() + 6); endOfWeek.setHours(23, 59, 59, 999); workoutsThisW = completedDates.filter(dateStr => { const d = new Date(dateStr + 'T00:00:00'); return d >= startOfWeek && d <= endOfWeek; }).length; } currentStreakDisplay.textContent = currentS; workoutsThisWeekDisplay.textContent = workoutsThisW; longestStreakDisplay.textContent = longestS; let message = "Start tracking to see your progress!"; if (longestS > 0 && longestS <= 7) message = "Keep going, consistency is key!"; else if (longestS > 7 && longestS <= 20) message = `Fantastic! A ${longestS}-day streak shows great habit formation!`; else if (longestS > 20 && longestS <= 50) message = `Incredible dedication! With a ${longestS}-day streak, you're a true FitTrack champion!`; else if (longestS > 50) message = `Wow, a ${longestS}-day streak! You're an inspiration!`; if (currentS > 7 && currentS >= longestS) { if (currentS <= 20) message = `Awesome! You're on a ${currentS}-day roll! Keep that fire burning!`; else if (currentS > 20) message = `Unstoppable! A ${currentS}-day streak is phenomenal! You're crushing it!`; } else if (currentS > 0 && currentS <=7 && longestS <=7) message = `You're on a ${currentS}-day streak! Every day counts!`; motivationalMessageEl.textContent = message; if (workouts.length === 0) { personalBestsListEl.innerHTML = '<p class="text-gray-500 italic">No workouts logged yet.</p>'; muscleGroupPbsListEl.innerHTML = '<p class="text-gray-500 italic">Log workouts to see muscle group focus.</p>'; return; } const personalBests = {}; const muscleGroupPBs = {}; workouts.forEach(workout => { const exerciseName = workout.exercise; const workoutType = workout.type || 'weight'; const value = parseFloat(workoutType === 'timed' ? workout.reps.split(' ')[0] : workout.weight); if (workoutType !== 'reps' && isNaN(value)) { return; } let isNewPb = false; if (!personalBests[exerciseName] || (workoutType === 'weight' && value > personalBests[exerciseName].value) || (workoutType === 'timed' && value > personalBests[exerciseName].value)) { isNewPb = true; } else if (workoutType === 'weight' && value === personalBests[exerciseName].value) { let currentPbRepsForComparison = parseInt(String(personalBests[exerciseName].reps).split('-')[0].trim()); let newEntryRepsForComparison = parseInt(String(workout.reps).split('-')[0].trim()); if (!isNaN(currentPbRepsForComparison) && !isNaN(newEntryRepsForComparison) && newEntryRepsForComparison > currentPbRepsForComparison) { isNewPb = true; } else if (!isNaN(currentPbRepsForComparison) && !isNaN(newEntryRepsForComparison) && newEntryRepsForComparison === currentPbRepsForComparison && new Date(workout.date) > new Date(personalBests[exerciseName].date)) { isNewPb = true; }} if (isNewPb) { personalBests[exerciseName] = { value: value, reps: workout.reps, date: workout.date, unit: workout.unit, type: workoutType, rpe: workout.rpe, notes: workout.notes, e1RM: 0, history: [workout] }; if (workoutType === 'weight') { let repsFor1RM = parseInt(String(workout.reps).split('-')[0].trim()); if (!isNaN(repsFor1RM) && repsFor1RM > 0) { personalBests[exerciseName].e1RM = value * (1 + repsFor1RM / 30); } } } else if (personalBests[exerciseName]) { if(!personalBests[exerciseName].history) personalBests[exerciseName].history = []; personalBests[exerciseName].history.push(workout); } const routineExercise = workoutRoutinesData.flatMap(day => day.exercises).find(ex => ex.name === exerciseName); if (routineExercise && routineExercise.muscleGroup) { const muscle = routineExercise.muscleGroup; if (!muscleGroupPBs[muscle]) { muscleGroupPBs[muscle] = []; } let existingMusclePbIndex = muscleGroupPBs[muscle].findIndex(pb => pb.exercise === exerciseName); if (personalBests[exerciseName] && personalBests[exerciseName].date === workout.date) { const pbDataForMuscle = { exercise: exerciseName, value: personalBests[exerciseName].value, reps: personalBests[exerciseName].reps, unit: personalBests[exerciseName].unit, type: personalBests[exerciseName].type, rpe: personalBests[exerciseName].rpe }; if (existingMusclePbIndex === -1) { muscleGroupPBs[muscle].push(pbDataForMuscle); } else { muscleGroupPBs[muscle][existingMusclePbIndex] = pbDataForMuscle; } } } }); if (Object.keys(personalBests).length === 0) { personalBestsListEl.innerHTML = '<p class="text-gray-500 italic">Log workouts for PBs!</p>'; } else { for (const exercise in personalBests) { const pb = personalBests[exercise]; const pbItemContainer = document.createElement('div'); pbItemContainer.className = 'bg-white p-4 rounded-lg shadow border border-gray-200'; const pbHeader = document.createElement('div'); pbHeader.className = 'flex justify-between items-center mb-2'; pbHeader.innerHTML = `<h4 class="text-md font-semibold text-gray-800">${exercise}</h4><button class="btn btn-small btn-primary-app text-xs toggle-history-btn">Show History</button>`; const pbDetails = document.createElement('p'); pbDetails.className = 'text-gray-600'; let pbText = ''; if (pb.type === 'timed') pbText = `PB: <span class="font-bold">${pb.reps}</span>`; else if (pb.type === 'reps') pbText = `PB: <span class="font-bold">${pb.reps} reps</span>`; else { pbText = `PB: <span class="font-bold">${pb.value} ${pb.unit}</span> for ${pb.reps} reps`; if (pb.e1RM > 0) pbText += `<br><span class="text-xs text-gray-500">Est. 1RM: ${pb.e1RM.toFixed(1)} ${pb.unit}</span>`; } if (pb.rpe) pbText += `<br><span class="text-xs text-gray-500">RPE: ${pb.rpe}</span>`; pbText += `<span class="text-xs text-gray-500 block mt-1">Achieved: ${new Date(pb.date + 'T00:00:00').toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}</span>`; pbDetails.innerHTML = pbText; const historyContent = document.createElement('div'); historyContent.className = 'accordion-content'; if (pb.history && pb.history.length > 1) { const historyList = document.createElement('ul'); historyList.className = 'space-y-1 text-xs text-gray-600 p-3'; pb.history.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 10).forEach(histEntry => { const histItem = document.createElement('li'); let histText = `${new Date(histEntry.date + 'T00:00:00').toLocaleDateString('en-GB', {day:'2-digit', month:'short'})}: `; if (histEntry.type === 'timed') histText += `${histEntry.reps} (S: ${histEntry.sets})`; else if (histEntry.type === 'reps') histText += `${histEntry.reps}r (S: ${histEntry.sets})`; else histText += `${histEntry.weight}${histEntry.unit} x ${histEntry.reps}r (S: ${histEntry.sets})`; if (histEntry.rpe) histText += ` (RPE: ${histEntry.rpe})`; if(histEntry.notes) histText += `<br><em class="text-gray-500">N: ${histEntry.notes}</em>`; histItem.innerHTML = histText; historyList.appendChild(histItem); }); historyContent.appendChild(historyList); } else { historyContent.innerHTML = '<p class="text-xs text-gray-500 italic p-3">No additional history.</p>'; } pbItemContainer.appendChild(pbHeader); pbItemContainer.appendChild(pbDetails); pbItemContainer.appendChild(historyContent); personalBestsListEl.appendChild(pbItemContainer); const toggleBtn = pbHeader.querySelector('.toggle-history-btn'); if (toggleBtn && historyContent) { setupAccordionToggle(toggleBtn, historyContent); }} } if (Object.keys(muscleGroupPBs).length === 0) { muscleGroupPbsListEl.innerHTML = '<p class="text-gray-500 italic">Log PBs for muscle focus.</p>'; } else { for (const muscle in muscleGroupPBs) { const muscleSection = document.createElement('div'); muscleSection.className = 'mb-4'; muscleSection.innerHTML = `<h5 class="text-md font-semibold text-gray-700 mb-1">${muscle}</h5>`; const list = document.createElement('ul'); list.className = 'list-disc list-inside pl-1 space-y-1 text-sm'; muscleGroupPBs[muscle].forEach(pb => { const item = document.createElement('li'); item.className = 'text-gray-600'; if (pb.type === 'timed') item.innerHTML = `${pb.exercise}: <span class="font-medium">${pb.reps}</span>`; else if (pb.type === 'reps') item.innerHTML = `${pb.exercise}: <span class="font-medium">${pb.reps} reps</span>`; else item.innerHTML = `${pb.exercise}: <span class="font-medium">${pb.value} ${pb.unit}</span> for ${pb.reps} reps`; if (pb.rpe) item.innerHTML += ` (RPE: ${pb.rpe})`; list.appendChild(item); }); muscleSection.appendChild(list); muscleGroupPbsListEl.appendChild(muscleSection); } } }

                // --- Day Routine & Active Exercise ---
                function startDayRoutine(dayIndex) { console.log(`DEBUG: startDayRoutine(${dayIndex}) CALLED and STARTED.`); if (!workoutRoutinesData || !workoutRoutinesData[dayIndex]) { console.error(`DEBUG: startDayRoutine - Invalid dayIndex or workoutRoutinesData missing for index ${dayIndex}`); showUserFeedback(activeWorkoutFeedback, 'Error: Could not find routine data.', 'error'); return; } if (activeWorkoutState || currentDayRoutine) { console.log("DEBUG: startDayRoutine - Session already active. Aborting."); showUserFeedback(activeWorkoutFeedback, 'Session active. Finish or cancel first.', 'error'); if(activeWorkoutSection) activeWorkoutSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); return; } currentDayRoutine = workoutRoutinesData[dayIndex]; currentExerciseIndex = 0; console.log(`DEBUG: startDayRoutine - Starting routine: ${currentDayRoutine.day}`); showUserFeedback(activeWorkoutFeedback, `Starting ${currentDayRoutine.day}!`, 'success'); if(viewToggleButtons) { Array.from(viewToggleButtons.children).forEach(btn => btn.disabled = true); console.log("DEBUG: startDayRoutine - View toggle buttons disabled."); } else { console.warn("DEBUG: startDayRoutine - viewToggleButtons element not found."); } workoutSessionStartTime = Date.now(); totalSetsThisSession = 0; if(workoutDurationDisplay) workoutDurationDisplay.textContent = "Session Duration: 00:00"; clearInterval(workoutDurationInterval); workoutDurationInterval = setInterval(updateWorkoutDurationDisplay, 1000); console.log("DEBUG: startDayRoutine - About to call startNextExerciseInDay()."); startNextExerciseInDay(); console.log("DEBUG: startDayRoutine - Finished."); }
                function updateWorkoutDurationDisplay() { if (!workoutSessionStartTime || !workoutDurationDisplay) return; const elapsedMs = Date.now() - workoutSessionStartTime; const elapsedSecondsTotal = Math.floor(elapsedMs / 1000); const minutes = Math.floor(elapsedSecondsTotal / 60); const seconds = elapsedSecondsTotal % 60; workoutDurationDisplay.textContent = `Session Duration: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; }
                function startNextExerciseInDay() { console.log("DEBUG: startNextExerciseInDay() CALLED and STARTED."); if (currentDayRoutine && currentExerciseIndex < currentDayRoutine.exercises.length) { const exercise = currentDayRoutine.exercises[currentExerciseIndex]; activeWorkoutState = { name: exercise.name, targetSets: parseInt(exercise.sets), currentSet: 1, lastWeightOrDuration: '', unit: activeUnitInput ? activeUnitInput.value : 'kg', originalRepsString: exercise.reps, type: exercise.type || 'weight', rpe: '', notes: '' }; if(activeExerciseNameDisplay) activeExerciseNameDisplay.textContent = activeWorkoutState.name; if(activeExerciseTargetsDisplay) activeExerciseTargetsDisplay.textContent = `Target: ${activeWorkoutState.targetSets} sets of ${activeWorkoutState.originalRepsString} reps`; if(currentExerciseInDayDisplay) currentExerciseInDayDisplay.textContent = `Exercise ${currentExerciseIndex + 1} of ${currentDayRoutine.exercises.length}`; if(activeSetDisplay) activeSetDisplay.textContent = `Set: ${activeWorkoutState.currentSet} / ${activeWorkoutState.targetSets}`; if(activeWorkoutState.type === 'timed') { if(activeWeightInputGroup) activeWeightInputGroup.classList.add('truly-hidden'); if(unitInputGroup) unitInputGroup.classList.add('truly-hidden'); if(rpeInputGroup) rpeInputGroup.classList.add('truly-hidden'); if(activeDurationInputGroup) activeDurationInputGroup.classList.remove('truly-hidden'); if(activeDurationInput) activeDurationInput.value = parseInt(activeWorkoutState.originalRepsString) || 30; if(activeDurationLabel) activeDurationLabel.textContent = "Duration (seconds)"; } else if (activeWorkoutState.type === 'reps') { if(activeWeightInputGroup) activeWeightInputGroup.classList.add('truly-hidden'); if(unitInputGroup) unitInputGroup.classList.add('truly-hidden'); if(activeDurationInputGroup) activeDurationInputGroup.classList.add('truly-hidden'); if(rpeInputGroup) rpeInputGroup.classList.remove('truly-hidden'); } else { if(activeWeightInputGroup) activeWeightInputGroup.classList.remove('truly-hidden'); if(unitInputGroup) unitInputGroup.classList.remove('truly-hidden'); if(rpeInputGroup) rpeInputGroup.classList.remove('truly-hidden'); if(activeDurationInputGroup) activeDurationInputGroup.classList.add('truly-hidden'); if(activeWeightInput) activeWeightInput.value = "0"; } if(activeNotesInput) activeNotesInput.value = ''; if(activeRpeSelect) activeRpeSelect.value = ''; if(activeUnitInput) activeUnitInput.value = activeWorkoutState.unit; setDefaultDate(activeWorkoutDateInput); if(activeWorkoutSection) activeWorkoutSection.classList.remove('truly-hidden'); if(activeWorkoutSection) activeWorkoutSection.scrollIntoView({ behavior: 'smooth', block: 'start' }); showUserFeedback(activeWorkoutFeedback, `${activeWorkoutState.name} started! Adjust inputs.`, 'success'); if(logSetButton) { logSetButton.disabled = false; logSetButton.textContent = "Log Set & Rest"; } if(finishExerciseButton) { finishExerciseButton.disabled = false; finishExerciseButton.textContent = "Finish Exercise & Next"; } if(activeWorkoutState.type === 'timed' && activeDurationInput) activeDurationInput.focus(); else if (activeWorkoutState.type !== 'reps' && activeWeightInput) activeWeightInput.focus(); else if (activeRpeSelect) activeRpeSelect.focus(); } else { finishDayRoutine(); } }
                function handleFinishExercise() { console.log("DEBUG: handleFinishExercise() CALLED and STARTED."); if (!activeWorkoutState) { console.error("DEBUG: handleFinishExercise - activeWorkoutState is null. Aborting."); return; } if (!activeWorkoutDateInput) { console.error("DEBUG: handleFinishExercise - activeWorkoutDateInput is null. Aborting."); return; } const workoutDate = activeWorkoutDateInput.value; if (!workoutDate) { showUserFeedback(activeWorkoutFeedback, 'Select date.', 'error'); activeWorkoutDateInput.focus(); return; } console.log("DEBUG: handleFinishExercise - Workout Date:", workoutDate); let valueToLog = activeWorkoutState.lastWeightOrDuration; let rpeValue = activeRpeSelect ? activeRpeSelect.value : ''; if (activeWorkoutState.type === 'timed') { if (valueToLog === '') valueToLog = activeDurationInput ? activeDurationInput.value : '0'; valueToLog = parseInt(valueToLog); console.log("DEBUG: handleFinishExercise - Timed, valueToLog:", valueToLog); if (isNaN(valueToLog) || valueToLog <=0) { showUserFeedback(activeWorkoutFeedback, 'Log duration.', 'error'); if(activeDurationInput) activeDurationInput.focus(); return; } rpeValue = ''; } else if (activeWorkoutState.type === 'weight') { if (valueToLog === '') valueToLog = activeWeightInput ? activeWeightInput.value : '0'; valueToLog = parseFloat(valueToLog); console.log("DEBUG: handleFinishExercise - Weight, valueToLog:", valueToLog); if (isNaN(valueToLog) || valueToLog < 0) { showUserFeedback(activeWorkoutFeedback, 'Log weight.', 'error'); if(activeWeightInput) activeWeightInput.focus(); return; } } else if (activeWorkoutState.type === 'reps') { valueToLog = ''; console.log("DEBUG: handleFinishExercise - Reps type."); } if (activeWorkoutState.type !== 'timed' && rpeInputGroup && !rpeInputGroup.classList.contains('truly-hidden')) { if (!rpeValue) { console.log("DEBUG: handleFinishExercise - RPE not selected."); showUserFeedback(activeWorkoutFeedback, 'Select RPE.', 'error'); if(activeRpeSelect) activeRpeSelect.focus(); return; } } console.log("DEBUG: handleFinishExercise - RPE value:", rpeValue); const newWorkoutEntry = { id: Date.now(), exercise: activeWorkoutState.name, sets: activeWorkoutState.targetSets, reps: activeWorkoutState.type === 'timed' ? `${valueToLog} sec` : activeWorkoutState.originalRepsString, weight: (activeWorkoutState.type === 'weight') ? valueToLog : '', unit: (activeWorkoutState.type === 'weight') ? activeWorkoutState.unit : '', type: activeWorkoutState.type, rpe: rpeValue, notes: activeWorkoutState.notes, date: workoutDate }; console.log("DEBUG: handleFinishExercise - New workout entry:", newWorkoutEntry); const workouts = loadWorkouts(); workouts.push(newWorkoutEntry); saveWorkouts(workouts); renderLoggedWorkoutsAccordion(); renderProgress(); showUserFeedback(activeWorkoutFeedback, `${activeWorkoutState.name} logged!`, 'success'); currentExerciseIndex++; activeWorkoutState = null; console.log("DEBUG: handleFinishExercise - About to call startNextExerciseInDay()."); startNextExerciseInDay(); console.log("DEBUG: handleFinishExercise() FINISHED."); }
                function finishDayRoutine() { const dayName = currentDayRoutine ? currentDayRoutine.day : 'Workout Day'; const exercisesDone = currentDayRoutine ? currentDayRoutine.exercises.length : 0; const durationText = workoutDurationDisplay ? workoutDurationDisplay.textContent.replace('Session Duration: ', '') : 'N/A'; if (activeWorkoutDateInput && activeWorkoutDateInput.value) { const workoutDateStr = activeWorkoutDateInput.value; const completedDays = loadCompletedDays(); completedDays[workoutDateStr] = true; saveCompletedDays(completedDays); if (calendarSection && !calendarSection.classList.contains('section-hidden')) { renderWeeklyCalendarView(); } } if(summaryModalTitle) summaryModalTitle.textContent = `${dayName} Completed!`; if(summaryTotalExercises) summaryTotalExercises.textContent = exercisesDone; if(summaryTotalSets) summaryTotalSets.textContent = totalSetsThisSession; if(summarySessionDuration) summarySessionDuration.textContent = durationText; if(workoutSummaryModal) { workoutSummaryModal.classList.remove('truly-hidden'); workoutSummaryModal.classList.add('visible'); } currentDayRoutine = null; currentExerciseIndex = -1; resetActiveWorkoutSessionUI(false); if(viewToggleButtons) Array.from(viewToggleButtons.children).forEach(btn => btn.disabled = false); clearInterval(workoutDurationInterval); if(workoutDurationDisplay) workoutDurationDisplay.textContent = "Session Duration: 00:00"; workoutSessionStartTime = null; totalSetsThisSession = 0; renderProgress(); }
                function resetActiveWorkoutSessionUI(showCancelMsg = true) { activeWorkoutState = null; if(activeWorkoutSection) activeWorkoutSection.classList.add('truly-hidden'); if(activeWeightInput) activeWeightInput.value = "0"; if(activeDurationInput) activeDurationInput.value = "30"; if(activeRpeSelect) activeRpeSelect.value = ""; if(activeNotesInput) activeNotesInput.value = ''; if(logSetButton) { logSetButton.disabled = false; logSetButton.textContent = "Log Set & Rest"; } if(finishExerciseButton) { finishExerciseButton.disabled = false; finishExerciseButton.textContent = "Finish Exercise & Next"; } if(showCancelMsg) { showUserFeedback(activeWorkoutFeedback, 'Session cleared.', 'success');} }
                function showCancelDayConfirmation() { if (cancelDayConfirmationModal) { cancelDayConfirmationModal.classList.remove('truly-hidden'); cancelDayConfirmationModal.classList.add('visible'); } }
                function hideCancelDayConfirmation() { if (cancelDayConfirmationModal) { cancelDayConfirmationModal.classList.remove('visible'); setTimeout(() => cancelDayConfirmationModal.classList.add('truly-hidden'), 300); } }
                function confirmCancelDayAction() { hideCancelDayConfirmation(); cancelCurrentDayRoutine(); }
                function cancelCurrentDayRoutine() { if (currentDayRoutine) { showUserFeedback(activeWorkoutFeedback, `${currentDayRoutine.day} cancelled.`, 'success');} else if (activeWorkoutState) { showUserFeedback(activeWorkoutFeedback, `Exercise cancelled.`, 'success');} else { showUserFeedback(activeWorkoutFeedback, `No active routine.`, 'info', 0); return; } currentDayRoutine = null; currentExerciseIndex = -1; resetActiveWorkoutSessionUI(false); stopAndHideRestTimer(false); if(viewToggleButtons) Array.from(viewToggleButtons.children).forEach(btn => btn.disabled = false); clearInterval(workoutDurationInterval); if(workoutDurationDisplay) workoutDurationDisplay.textContent = "Session Duration: 00:00"; workoutSessionStartTime = null; }

                // --- Timer Logic Definitions ---
                function requestNotificationPermission() { if ('Notification' in window) { if (Notification.permission !== "granted" && Notification.permission !== "denied") { console.log('Requesting notification permission...'); Notification.requestPermission().then(permission => { if (permission === "granted") { console.log("Notification permission granted."); showUserFeedback(settingsFeedback || activeWorkoutFeedback || appHeader, "Notifications enabled!", "success", 2000); } else { console.log("Notification permission denied."); showUserFeedback(settingsFeedback || activeWorkoutFeedback || appHeader, "Notifications denied.", "warning", 4000); } }); } else if (Notification.permission === "denied"){ console.log("Notification permission previously denied."); } else { console.log("Notification permission already granted."); } } else { console.log("Notifications not supported."); } }
                function updateTimerDisplays() { if(!timerDisplayFullscreen || !minimizedTimerBarText) return; const minutes = Math.floor(remainingSecondsForCountdown / 60); const seconds = remainingSecondsForCountdown % 60; const timeString = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; timerDisplayFullscreen.textContent = timeString; minimizedTimerBarText.textContent = `Rest: ${timeString}`; }
                function startRestTimerVisuals() { if (remainingSecondsForCountdown <= 0) return; restTimerState = 'running'; isTimerMinimized = false; if(mainAppContentWrapper) mainAppContentWrapper.classList.add('hidden-for-timer'); if(fullscreenTimerOverlay) { fullscreenTimerOverlay.classList.remove('truly-hidden'); requestAnimationFrame(() => { fullscreenTimerOverlay.classList.add('visible'); }); } if(minimizedTimerBar) minimizedTimerBar.classList.add('truly-hidden'); updateFullscreenPauseResumeButton(false); updateMinimizedPauseResumeButton(false); updateTimerDisplays(); clearInterval(timerInterval); timerInterval = setInterval(() => { if (restTimerState === 'running' && remainingSecondsForCountdown > 0) { remainingSecondsForCountdown--; updateTimerDisplays(); } else if (remainingSecondsForCountdown <= 0 && restTimerState !== 'finished') { restTimerState = 'finished'; endRestTimerExperience(); } }, 1000); }
                function handleZeroRestScenario() { if (logSetButton && activeWorkoutState && activeWorkoutState.currentSet <= activeWorkoutState.targetSets) logSetButton.disabled = false; if (finishExerciseButton) finishExerciseButton.disabled = false; if (mainAppContentWrapper) mainAppContentWrapper.classList.remove('hidden-for-timer'); if (fullscreenTimerOverlay) { fullscreenTimerOverlay.classList.remove('visible'); fullscreenTimerOverlay.classList.add('truly-hidden'); } if (minimizedTimerBar) minimizedTimerBar.classList.add('truly-hidden'); isTimerMinimized = false; restTimerState = 'idle'; if (activeWorkoutSection && !activeWorkoutSection.classList.contains('truly-hidden')) { if (activeWorkoutState && activeWorkoutState.type === 'timed' && activeDurationInput) activeDurationInput.focus(); else if (activeWorkoutState && activeWorkoutState.type === 'weight' && activeWeightInput) activeWeightInput.focus(); else if (activeWorkoutState && activeWorkoutState.type === 'reps' && activeRpeSelect) activeRpeSelect.focus(); } }
                function pauseRestTimer() { if (restTimerState === 'running') { restTimerState = 'paused'; updateFullscreenPauseResumeButton(true); updateMinimizedPauseResumeButton(true); showUserFeedback(activeWorkoutFeedback, "Rest timer paused.", "info", 2000); } }
                function resumeRestTimer() { if (restTimerState === 'paused') { if (remainingSecondsForCountdown <= 0) { restTimerState = 'finished'; endRestTimerExperience(); return; } restTimerState = 'running'; updateFullscreenPauseResumeButton(false); updateMinimizedPauseResumeButton(false); } }
                function add15SecondsToRest() { if (restTimerState === 'running' || restTimerState === 'paused') { remainingSecondsForCountdown += 15; updateTimerDisplays(); showUserFeedback(activeWorkoutFeedback, "+15s added to rest.", "success", 1500); } }
                function stopAndHideRestTimer(stoppedByUser = true) { const wasRunningOrPaused = (restTimerState === 'running' || restTimerState === 'paused'); clearInterval(timerInterval); restTimerState = 'finished'; remainingSecondsForCountdown = 0; updateTimerDisplays(); if(mainAppContentWrapper) mainAppContentWrapper.classList.remove('hidden-for-timer'); if(fullscreenTimerOverlay) { fullscreenTimerOverlay.classList.remove('visible'); fullscreenTimerOverlay.classList.add('truly-hidden'); } if(minimizedTimerBar) { minimizedTimerBar.classList.add('truly-hidden'); minimizedTimerBar.classList.remove('times-up-flash'); } isTimerMinimized = false; if(logSetButton && activeWorkoutState && activeWorkoutState.currentSet <= activeWorkoutState.targetSets) logSetButton.disabled = false; if(finishExerciseButton) finishExerciseButton.disabled = false; if (stoppedByUser) showUserFeedback(activeWorkoutFeedback, "Rest stopped. Continue workout.", "info", 2000); if (wasRunningOrPaused && 'serviceWorker' in navigator && navigator.serviceWorker.controller) { console.log('Main Script: Sending cancel message to SW'); navigator.serviceWorker.controller.postMessage({ type: 'CANCEL_REST_TIMER' }); } if(activeWorkoutSection && !activeWorkoutSection.classList.contains('truly-hidden')) { activeWorkoutSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); if(activeWorkoutState && activeWorkoutState.type === 'timed' && activeDurationInput) activeDurationInput.focus(); else if(activeWorkoutState && activeWorkoutState.type === 'weight' && activeWeightInput) activeWeightInput.focus(); else if (activeWorkoutState && activeWorkoutState.type === 'reps' && activeRpeSelect) activeRpeSelect.focus(); } restTimerState = 'idle'; }
                function endRestTimerExperience() { if (restTimerState === 'finished' || restTimerState === 'running') { if (restTimerState !== 'finished') { clearInterval(timerInterval); restTimerState = 'finished'; } else { console.log("endRestTimerExperience called again, skipping logic."); return; } if(timerDisplayFullscreen) timerDisplayFullscreen.textContent = "Time's Up!"; if(minimizedTimerBar) { minimizedTimerBarText.textContent = "Time's Up!"; minimizedTimerBar.classList.add('times-up-flash'); if (!isTimerMinimized) minimizedTimerBar.classList.remove('truly-hidden'); } if(activeWorkoutFeedback) showUserFeedback(activeWorkoutFeedback, "Rest finished! Back to workout.", "success", 2000); if (document.hasFocus() && navigator.vibrate) navigator.vibrate([200, 100, 200]); setTimeout(() => { if (restTimerState === 'finished') { if(mainAppContentWrapper) mainAppContentWrapper.classList.remove('hidden-for-timer'); if(fullscreenTimerOverlay) { fullscreenTimerOverlay.classList.remove('visible'); fullscreenTimerOverlay.classList.add('truly-hidden'); } if(minimizedTimerBar) { minimizedTimerBar.classList.add('truly-hidden'); minimizedTimerBar.classList.remove('times-up-flash'); } if(timerDisplayFullscreen && timerDisplayFullscreen.textContent === "Time's Up!") timerDisplayFullscreen.textContent = "00:00"; if(logSetButton && activeWorkoutState && activeWorkoutState.currentSet <= activeWorkoutState.targetSets) logSetButton.disabled = false; if(finishExerciseButton) finishExerciseButton.disabled = false; if(activeWorkoutSection && !activeWorkoutSection.classList.contains('truly-hidden')) { activeWorkoutSection.scrollIntoView({ behavior: 'smooth', block: 'center' }); if(activeWorkoutState && activeWorkoutState.type === 'timed' && activeDurationInput) activeDurationInput.focus(); else if(activeWorkoutState && activeWorkoutState.type === 'weight' && activeWeightInput) activeWeightInput.focus(); else if (activeWorkoutState && activeWorkoutState.type === 'reps' && activeRpeSelect) activeRpeSelect.focus(); } restTimerState = 'idle'; } }, 2500); } }
                function handleMinimizeTimer() { if (fullscreenTimerOverlay && mainAppContentWrapper && minimizedTimerBar && appHeader) { fullscreenTimerOverlay.classList.remove('visible'); fullscreenTimerOverlay.classList.add('truly-hidden'); mainAppContentWrapper.classList.remove('hidden-for-timer'); minimizedTimerBar.classList.remove('truly-hidden'); isTimerMinimized = true; } }
                function handleMaximizeTimer() { if (fullscreenTimerOverlay && mainAppContentWrapper && minimizedTimerBar) { minimizedTimerBar.classList.add('truly-hidden'); mainAppContentWrapper.classList.add('hidden-for-timer'); fullscreenTimerOverlay.classList.remove('truly-hidden'); fullscreenTimerOverlay.classList.add('visible'); isTimerMinimized = false; } }
                function updateFullscreenPauseResumeButton(isPaused) { if (fullscreenPlayIcon && fullscreenPauseIcon && fullscreenPauseResumeBtn) { fullscreenPlayIcon.classList.toggle('truly-hidden', !isPaused); fullscreenPauseIcon.classList.toggle('truly-hidden', isPaused); fullscreenPauseResumeBtn.classList.remove('btn-primary-app', 'btn-warning-app'); if (isPaused) fullscreenPauseResumeBtn.classList.add('btn-primary-app'); else fullscreenPauseResumeBtn.classList.add('btn-warning-app'); } }
                function updateMinimizedPauseResumeButton(isPaused) { if (minimizedPlayIconPath && minimizedPauseIconPath && minimizedPauseResumeBtn) { minimizedPlayIconPath.classList.toggle('truly-hidden', !isPaused); minimizedPauseIconPath.classList.toggle('truly-hidden', isPaused); minimizedPauseResumeBtn.classList.remove('btn-primary-app', 'btn-warning-app'); if (isPaused) minimizedPauseResumeBtn.classList.add('btn-primary-app'); else minimizedPauseResumeBtn.classList.add('btn-warning-app'); } }

                // --- Core Action Functions ---
                function handleLogSet() { console.log("DEBUG: handleLogSet() CALLED and STARTED."); if (!activeWorkoutState) { console.error("DEBUG: handleLogSet - activeWorkoutState is null. Aborting."); return; } let feedbackMessage = `Set ${activeWorkoutState.currentSet} noted. `; if (activeWorkoutState.type === 'timed') { if (!activeDurationInput) { console.error("DEBUG: handleLogSet - activeDurationInput is null!"); return; } const duration = parseInt(activeDurationInput.value); console.log("DEBUG: handleLogSet - Timed exercise, duration:", duration); if (isNaN(duration) || duration <=0) { showUserFeedback(activeWorkoutFeedback, 'Enter valid duration.', 'error'); if(activeDurationInput) activeDurationInput.focus(); return; } activeWorkoutState.lastWeightOrDuration = duration; feedbackMessage = `Set ${activeWorkoutState.currentSet} (${duration} sec) noted. `; } else if (activeWorkoutState.type === 'weight') { if (!activeWeightInput) { console.error("DEBUG: handleLogSet - activeWeightInput is null!"); return; } const weight = parseFloat(activeWeightInput.value); console.log("DEBUG: handleLogSet - Weight exercise, weight:", weight); if (isNaN(weight) || weight < 0) { showUserFeedback(activeWorkoutFeedback, 'Enter valid weight.', 'error'); if(activeWeightInput) activeWeightInput.focus(); return; } activeWorkoutState.lastWeightOrDuration = weight; if(activeUnitInput) activeWorkoutState.unit = activeUnitInput.value; feedbackMessage = `Set ${activeWorkoutState.currentSet} (${weight}${activeWorkoutState.unit}) noted. `; } activeWorkoutState.notes = activeNotesInput ? activeNotesInput.value : ''; totalSetsThisSession++; console.log("DEBUG: handleLogSet - totalSetsThisSession:", totalSetsThisSession); if (activeWorkoutState.currentSet < activeWorkoutState.targetSets) { activeWorkoutState.currentSet++; if(activeSetDisplay) activeSetDisplay.textContent = `Set: ${activeWorkoutState.currentSet} / ${activeWorkoutState.targetSets}`; } else { if(activeSetDisplay) activeSetDisplay.textContent = `All sets noted! Finish exercise.`; if(logSetButton) logSetButton.disabled = true; if(finishExerciseButton) finishExerciseButton.focus(); } console.log("DEBUG: handleLogSet - UI updated for next set or finish."); if(logSetButton) logSetButton.disabled = true; if(finishExerciseButton) finishExerciseButton.disabled = true; const currentTotalRestSeconds = (defaultRestMinutes * 60) + defaultRestSeconds; console.log("DEBUG: handleLogSet - currentTotalRestSeconds:", currentTotalRestSeconds); if (currentTotalRestSeconds <= 0) { showUserFeedback(activeWorkoutFeedback, feedbackMessage + "Rest time is 0. Skipping rest.", "info"); handleZeroRestScenario(); return; } const now = Date.now(); const totalRestMillis = currentTotalRestSeconds * 1000; const endTime = now + totalRestMillis; if ('serviceWorker' in navigator && navigator.serviceWorker.controller) { console.log('DEBUG: handleLogSet - Sending schedule message to SW', { endTime }); navigator.serviceWorker.controller.postMessage({ type: 'SCHEDULE_REST_END', endTime: endTime }); showUserFeedback(activeWorkoutFeedback, feedbackMessage + "Starting rest (background enabled)...", "success"); } else { console.warn("DEBUG: handleLogSet - SW controller not available. Background timer may fail."); showUserFeedback(activeWorkoutFeedback, feedbackMessage + "Starting rest (background timer may fail)...", "success"); } remainingSecondsForCountdown = currentTotalRestSeconds; startRestTimerVisuals(); console.log("DEBUG: handleLogSet() FINISHED."); }

                // --- Settings Modal Logic ---
                function openSettingsModal() { console.log("DEBUG: openSettingsModal() function CALLED and STARTED."); if(settingsModal && settingsTimerMinutesInput && settingsTimerSecondsInput) { settingsTimerMinutesInput.value = defaultRestMinutes; settingsTimerSecondsInput.value = defaultRestSeconds; settingsModal.classList.remove('truly-hidden'); settingsModal.classList.add('visible'); console.log("DEBUG: Settings modal should now be visible."); } else { console.error("DEBUG: openSettingsModal - Critical elements (settingsModal, settingsTimerMinutesInput, or settingsTimerSecondsInput) not found!"); } }
                function closeSettingsModal() { if(settingsModal) { settingsModal.classList.remove('visible'); setTimeout(() => { settingsModal.classList.add('truly-hidden'); if(resetConfirmationArea) resetConfirmationArea.classList.add('truly-hidden'); }, 300); } }
                function saveTimerSettings() { if(!settingsTimerMinutesInput || !settingsTimerSecondsInput) return; const mins = parseInt(settingsTimerMinutesInput.value); const secs = parseInt(settingsTimerSecondsInput.value); if (isNaN(mins) || mins < 0 || mins > 59 || isNaN(secs) || secs < 0 || secs > 59) { showUserFeedback(settingsFeedback, "Invalid time.", "error"); return; } defaultRestMinutes = mins; defaultRestSeconds = secs; localStorage.setItem('fitTrackRestMinutes', defaultRestMinutes.toString()); localStorage.setItem('fitTrackRestSeconds', defaultRestSeconds.toString()); showUserFeedback(settingsFeedback, "Settings saved!", "success"); setTimeout(closeSettingsModal, 1500); }
                function loadTimerSettings() { const savedMins = localStorage.getItem('fitTrackRestMinutes'); const savedSecs = localStorage.getItem('fitTrackRestSeconds'); defaultRestMinutes = (savedMins !== null && !isNaN(parseInt(savedMins))) ? parseInt(savedMins) : 1; defaultRestSeconds = (savedSecs !== null && !isNaN(parseInt(savedSecs))) ? parseInt(savedSecs) : 30; }
                function handleShowResetConfirmation() { if(resetConfirmationArea) resetConfirmationArea.classList.remove('truly-hidden'); }
                function handleCancelReset() { if(resetConfirmationArea) resetConfirmationArea.classList.add('truly-hidden'); }
                function handleConfirmReset() { localStorage.removeItem('fitTrackWorkouts'); localStorage.removeItem('fitTrackRestMinutes'); localStorage.removeItem('fitTrackRestSeconds'); localStorage.removeItem('fitTrackCompletedDays'); localStorage.removeItem('fitTrackBodyWeights'); defaultRestMinutes = 1; defaultRestSeconds = 30; if(settingsTimerMinutesInput) settingsTimerMinutesInput.value = defaultRestMinutes; if(settingsTimerSecondsInput) settingsTimerSecondsInput.value = defaultRestSeconds; renderLoggedWorkoutsAccordion(); renderProgress(); renderWorkoutRoutines(); renderBodyWeightLog(); renderWeeklyCalendarView(); showUserFeedback(settingsFeedback, "App data reset.", "success"); if(resetConfirmationArea) resetConfirmationArea.classList.add('truly-hidden'); }
                function exportAllData() { const dataToExport = { workouts: loadWorkouts(), bodyWeights: loadBodyWeights(), timerSettings: { minutes: defaultRestMinutes, seconds: defaultRestSeconds }, completedDays: loadCompletedDays() }; const jsonString = JSON.stringify(dataToExport, null, 2); const blob = new Blob([jsonString], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'fittrack_backup.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showUserFeedback(settingsFeedback, "Data exported!", "success"); }
                function handleImportData() { if (!importFileEl || !importFileEl.files || importFileEl.files.length === 0) { showUserFeedback(settingsFeedback, "Select JSON file.", "error"); return; } const file = importFileEl.files[0]; if (file.type !== "application/json") { showUserFeedback(settingsFeedback, "Invalid file type.", "error"); return; } const reader = new FileReader(); reader.onload = function(event) { try { const importedData = JSON.parse(event.target.result); if (!importedData || typeof importedData !== 'object' || !('workouts' in importedData) || !('bodyWeights' in importedData) || !('timerSettings' in importedData) || !('completedDays' in importedData)) throw new Error("Invalid data structure."); saveWorkouts(importedData.workouts || []); saveBodyWeights(importedData.bodyWeights || []); saveCompletedDays(importedData.completedDays || {}); if (importedData.timerSettings) { defaultRestMinutes = parseInt(importedData.timerSettings.minutes) || 1; defaultRestSeconds = parseInt(importedData.timerSettings.seconds) || 30; localStorage.setItem('fitTrackRestMinutes', defaultRestMinutes.toString()); localStorage.setItem('fitTrackRestSeconds', defaultRestSeconds.toString()); if(settingsTimerMinutesInput) settingsTimerMinutesInput.value = defaultRestMinutes; if(settingsTimerSecondsInput) settingsTimerSecondsInput.value = defaultRestSeconds; } showUserFeedback(settingsFeedback, "Import successful! Reloading...", "success", 2500); setTimeout(() => { window.location.reload(); }, 2600); } catch (e) { console.error("Error importing data:", e); showUserFeedback(settingsFeedback, `Import Error: ${e.message}`, "error", 5000); } finally { importFileEl.value = ''; } }; reader.onerror = function() { showUserFeedback(settingsFeedback, "Error reading file.", "error"); importFileEl.value = ''; }; reader.readAsText(file); }

                // --- Body Weight Logging ---
                function logBodyWeight(event) { event.preventDefault(); if (!bodyWeightInputEl || !bodyWeightUnitEl || !bodyWeightDateEl || !bodyWeightFeedback) return; const weight = parseFloat(bodyWeightInputEl.value); const unit = bodyWeightUnitEl.value; const date = bodyWeightDateEl.value; if (isNaN(weight) || weight <= 0) { showUserFeedback(bodyWeightFeedback, "Enter valid weight.", "error"); return; } if (!date) { showUserFeedback(bodyWeightFeedback, "Select date.", "error"); return; } const newEntry = { id: Date.now(), weight: weight, unit: unit, date: date }; const bodyWeights = loadBodyWeights(); bodyWeights.push(newEntry); saveBodyWeights(bodyWeights); renderBodyWeightLog(); showUserFeedback(bodyWeightFeedback, "Body weight logged!", "success"); bodyWeightForm.reset(); setDefaultDate(bodyWeightDateEl); }

                // --- View Toggle Logic with Logging ---
                function toggleView(showSection) { console.log(`toggleView: Called with section = ${showSection}`); if (!workoutRoutinesSection || !calendarSection || !workoutListSection || !progressSection || !bodyWeightSection || !showRoutinesBtn || !showLogBtn || !showCalendarBtn || !showBodyWeightBtn || !progressBtn) { console.error("toggleView: One or more required elements not found!"); return; } workoutRoutinesSection.classList.add('section-hidden'); calendarSection.classList.add('section-hidden'); workoutListSection.classList.add('section-hidden'); progressSection.classList.add('section-hidden'); bodyWeightSection.classList.add('section-hidden'); showRoutinesBtn.classList.remove('active'); showLogBtn.classList.remove('active'); showCalendarBtn.classList.remove('active'); showBodyWeightBtn.classList.remove('active'); progressBtn.classList.remove('active'); try { if (showSection === 'routines') { console.log("toggleView: Showing routines section."); workoutRoutinesSection.classList.remove('section-hidden'); showRoutinesBtn.classList.add('active'); } else if (showSection === 'calendar') { console.log("toggleView: Showing calendar section."); calendarSection.classList.remove('section-hidden'); showCalendarBtn.classList.add('active'); renderWeeklyCalendarView(); } else if (showSection === 'log') { console.log("toggleView: Showing log section."); workoutListSection.classList.remove('section-hidden'); showLogBtn.classList.add('active'); renderLoggedWorkoutsAccordion(); } else if (showSection === 'bodyweight') { console.log("toggleView: Showing bodyweight section."); bodyWeightSection.classList.remove('section-hidden'); showBodyWeightBtn.classList.add('active'); renderBodyWeightLog(); } else if (showSection === 'progress') { console.log("toggleView: Showing progress section."); progressSection.classList.remove('section-hidden'); progressBtn.classList.add('active'); renderProgress(); } else { console.warn(`toggleView: Unknown section requested: ${showSection}`); } } catch (toggleShowError) { console.error(`toggleView: Error showing section ${showSection}:`, toggleShowError); } console.log(`toggleView: Finished for section = ${showSection}`); }
                function displayCurrentDayInfo() { if (!currentDayInfo) return; const today = new Date(); const dayOfWeek = today.getDay(); const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]; let activity = "Rest Day"; if (dayOfWeek === 1 && workoutRoutinesData[0]) activity = workoutRoutinesData[0].day; else if (dayOfWeek === 2 && workoutRoutinesData[1]) activity = workoutRoutinesData[1].day; else if (dayOfWeek === 4 && workoutRoutinesData[2]) activity = workoutRoutinesData[2].day; else if (dayOfWeek === 5 && workoutRoutinesData[3]) activity = workoutRoutinesData[3].day; else if (dayOfWeek === 6 && workoutRoutinesData[4]) activity = workoutRoutinesData[4].day; currentDayInfo.textContent = `Today: ${days[dayOfWeek]} - ${activity.includes(':') ? activity.split(':')[1].trim() : activity}`; }

                // --- Login Logic ---
                function attemptLogin() {
                    console.log("DEBUG: attemptLogin() function has been successfully CALLED and STARTED.");
                    if (!passwordInput) { console.error("attemptLogin: passwordInput element is null!"); return; }
                    if (!loginScreen) { console.error("attemptLogin: loginScreen element is null!"); return; }
                    if (!appContainer) { console.error("attemptLogin: appContainer element is null!"); return; }
                    // loginFeedback can be null if not found, will be handled by showUserFeedback
                    const enteredPassword = passwordInput.value; console.log("Password entered:", enteredPassword);
                    if (enteredPassword === '1234') {
                        console.log("Password CORRECT. Hiding login, showing app...");
                        loginScreen.classList.add('truly-hidden'); appContainer.classList.remove('truly-hidden');
                        sessionStorage.setItem('isFitTrackLoggedIn', 'true'); if(loginFeedback) loginFeedback.textContent = '';
                        console.log("Calling initializeApp()...");
                        try { initializeApp(); console.log("initializeApp() finished."); }
                        catch (initError) { console.error("ERROR occurred within initializeApp():", initError); }
                    } else { console.log("Password INCORRECT."); if (loginFeedback) { showUserFeedback(loginFeedback, 'Incorrect password.', 'error', 0); } else { alert('Incorrect password.'); } passwordInput.value = ''; passwordInput.focus(); }
                }

                // --- Initialize App with Logging ---
                function initializeApp() {
                    console.log("initializeApp: Function Started.");
                    try {
                        loadTimerSettings(); renderLoggedWorkoutsAccordion(); renderProgress();
                        setDefaultDate(activeWorkoutDateInput); setDefaultDate(bodyWeightDateEl);
                        renderBodyWeightLog();
                        console.log("initializeApp: About to call renderWorkoutRoutines().");
                        renderWorkoutRoutines();
                        console.log("initializeApp: renderWorkoutRoutines() potentially finished.");
                        displayCurrentDayInfo();
                        console.log("initializeApp: About to call toggleView('routines').");
                        toggleView('routines');
                        console.log("initializeApp: toggleView('routines') potentially finished.");
                        requestNotificationPermission(); // Call it here for now, can be moved
                        if (activeUnitInput && activeUnitDisplayValue) { activeUnitInput.addEventListener('change', function() { if(activeUnitDisplayValue) activeUnitDisplayValue.textContent = this.value; if (activeWorkoutState) { activeWorkoutState.unit = this.value; } }); if(activeUnitDisplayValue) activeUnitDisplayValue.textContent = activeUnitInput.value; }
                        if (togglePBsBtn && personalBestsListEl) setupAccordionToggle(togglePBsBtn, personalBestsListEl);
                        if (toggleMuscleFocusBtn && muscleGroupPbsListEl) setupAccordionToggle(toggleMuscleFocusBtn, muscleGroupPbsListEl);
                        if(document.getElementById('currentYear')) document.getElementById('currentYear').textContent = new Date().getFullYear();
                    } catch (initError) { console.error("initializeApp: ERROR during initialization steps:", initError); }
                    console.log("initializeApp: Function Finished.");
                }

                // ========================================================
                // --- Event Listeners (AFTER ALL FUNCTION DEFINITIONS) ---
                // ========================================================
                if (loginButton) { console.log("DEBUG: loginButton element found. Attaching click listener."); loginButton.addEventListener('click', function onLoginButtonClick() { console.log("DEBUG: Login button CLICKED. Now attempting to call attemptLogin()."); try { if (typeof attemptLogin === 'function') { console.log("DEBUG: attemptLogin IS a function. Calling it now."); attemptLogin(); } else { console.error("DEBUG: attemptLogin is NOT a function or is undefined at this point!"); } } catch (e_click) { console.error("DEBUG: Error occurred *within* the login button click handler:", e_click); } console.log("DEBUG: Finished login button click handler."); });
                } else { console.error("DEBUG: loginButton element NOT found! Cannot attach listener."); }
                if (passwordInput) { console.log("DEBUG: passwordInput element found. Attaching keypress listener."); passwordInput.addEventListener('keypress', function onPasswordEnter(event) { if (event.key === 'Enter') { console.log("DEBUG: Enter key pressed in password input. Now attempting to call attemptLogin()."); try { if (typeof attemptLogin === 'function') { console.log("DEBUG: attemptLogin IS a function (from enter key). Calling it now."); attemptLogin(); } else { console.error("DEBUG: attemptLogin is NOT a function (from enter key)!"); } } catch (e_enter) { console.error("DEBUG: Error occurred *within* password enter key handler:", e_enter); } console.log("DEBUG: Finished password enter key handler."); } });
                } else { console.error("DEBUG: passwordInput element NOT found! Cannot attach listener."); }

                if (settingsCogButton) { console.log("DEBUG: settingsCogButton element found. Attaching click listener."); settingsCogButton.addEventListener('click', function onSettingsCogClick() { console.log("DEBUG: Settings cog button CLICKED. Attempting to call openSettingsModal()."); try { if (typeof openSettingsModal === 'function') { console.log("DEBUG: openSettingsModal IS a function. Calling it now."); openSettingsModal(); } else { console.error("DEBUG: openSettingsModal is NOT a function or is undefined!"); } } catch (e_settings_click) { console.error("DEBUG: Error occurred *within* settings cog click handler:", e_settings_click); } console.log("DEBUG: Finished settings cog click handler."); });
                } else { console.error("DEBUG: settingsCogButton element NOT found!"); }

                if(logSetButton) { console.log("DEBUG: logSetButton element found. Attaching listener."); logSetButton.addEventListener('click', handleLogSet); } else { console.error("DEBUG: logSetButton element NOT found!"); }
                if(finishExerciseButton) { console.log("DEBUG: finishExerciseButton element found. Attaching listener."); finishExerciseButton.addEventListener('click', handleFinishExercise); } else { console.error("DEBUG: finishExerciseButton element NOT found!"); }

                if(closeSettingsModalBtn) closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
                if(saveTimerSettingsBtn) saveTimerSettingsBtn.addEventListener('click', saveTimerSettings);
                if(showResetConfirmationBtn) showResetConfirmationBtn.addEventListener('click', handleShowResetConfirmation);
                if(confirmResetBtn) confirmResetBtn.addEventListener('click', handleConfirmReset);
                if(cancelResetBtn) cancelResetBtn.addEventListener('click', handleCancelReset);
                if(exportDataBtn) exportDataBtn.addEventListener('click', exportAllData);
                if(importDataBtn) importDataBtn.addEventListener('click', handleImportData);
                if(showCancelDayConfirmationBtn) showCancelDayConfirmationBtn.addEventListener('click', showCancelDayConfirmation);
                if(confirmCancelDayBtn) confirmCancelDayBtn.addEventListener('click', confirmCancelDayAction);
                if(dontCancelDayBtn) dontCancelDayBtn.addEventListener('click', hideCancelDayConfirmation);
                if(bodyWeightForm) bodyWeightForm.addEventListener('submit', logBodyWeight);
                if(okSummaryModalBtn) okSummaryModalBtn.addEventListener('click', () => { if(workoutSummaryModal) { workoutSummaryModal.classList.remove('visible'); setTimeout(() => workoutSummaryModal.classList.add('truly-hidden'), 300); } });
                if(closeSummaryModalBtn) closeSummaryModalBtn.addEventListener('click', () => { if(workoutSummaryModal) { workoutSummaryModal.classList.remove('visible'); setTimeout(() => workoutSummaryModal.classList.add('truly-hidden'), 300); } });
                if(fullscreenPauseResumeBtn) fullscreenPauseResumeBtn.addEventListener('click', () => { if (restTimerState === 'running') pauseRestTimer(); else if (restTimerState === 'paused') resumeRestTimer(); });
                if(fullscreenAdd15sBtn) fullscreenAdd15sBtn.addEventListener('click', add15SecondsToRest);
                if(fullscreenStopBtn) fullscreenStopBtn.addEventListener('click', () => stopAndHideRestTimer(true));
                if(fullscreenMinimizeBtn) fullscreenMinimizeBtn.addEventListener('click', handleMinimizeTimer);
                if(minimizedPauseResumeBtn) minimizedPauseResumeBtn.addEventListener('click', () => { if (restTimerState === 'running') pauseRestTimer(); else if (restTimerState === 'paused') resumeRestTimer(); });
                if(minimizedAdd15sBtn) minimizedAdd15sBtn.addEventListener('click', add15SecondsToRest);
                if(minimizedStopBtn) minimizedStopBtn.addEventListener('click', () => stopAndHideRestTimer(true));
                if(minimizedMaximizeBtn) minimizedMaximizeBtn.addEventListener('click', handleMaximizeTimer);
                if(showRoutinesBtn) showRoutinesBtn.addEventListener('click', () => toggleView('routines'));
                if(showLogBtn) showLogBtn.addEventListener('click', () => toggleView('log'));
                if(showCalendarBtn) showCalendarBtn.addEventListener('click', () => toggleView('calendar'));
                if(showBodyWeightBtn) showBodyWeightBtn.addEventListener('click', () => toggleView('bodyweight'));
                if(progressBtn) progressBtn.addEventListener('click', () => toggleView('progress'));

                // --- Initial Setup Logic ---
                if (!loginScreen || !appContainer) { console.error("Critical DOM elements missing."); return; }
                if (sessionStorage.getItem('isFitTrackLoggedIn') === 'true') { loginScreen.classList.add('truly-hidden'); appContainer.classList.remove('truly-hidden'); initializeApp(); }
                else { appContainer.classList.add('truly-hidden'); loginScreen.classList.remove('truly-hidden'); if(passwordInput) passwordInput.focus(); }

                // --- Service Worker Registration ---
                if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/service-worker.js').then(reg => { console.log('SW registered!', reg.scope); reg.addEventListener('updatefound', () => { const newWorker = reg.installing; console.log('SW Update Found', newWorker); newWorker.addEventListener('statechange', () => { console.log('SW State Change:', newWorker.state); if (newWorker.state === 'installed' && navigator.serviceWorker.controller) { console.log('New SW installed and ready to activate.'); } }); }); }).catch(err => console.log('SW registration failed: ', err)); navigator.serviceWorker.addEventListener('controllerchange', () => { console.log('SW Controller Changed - new SW activated.'); }); }); }
                else { console.log('Service Worker not supported'); showUserFeedback(appHeader || document.body, "Offline/Background features disabled (Browser unsupported).", "warning", 0); }

            } catch (e) {
                console.error("Global script error:", e);
                const body = document.body || document.createElement('body');
                if (!document.body) document.documentElement.appendChild(body);
                body.innerHTML = "<p style='color:red;font-family:sans-serif;padding:20px;'>A critical error occurred loading FitTrack script. Please check the console.</p>";
            }
        });
    </script>
</body>
</html>
```
