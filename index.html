<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <!-- Use relative path for manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2D3748">
    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FitTrack">
    <!-- Use relative path for apple-touch-icon -->
    <link rel="apple-touch-icon" href="icons/icon-180x180.png">
    <title>FitTrack - Your Fitness Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { overflow-y: scroll; } body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #1f2937; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; } ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .content-section { background-color: white; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.3s ease, box-shadow 0.3s ease, color 0.3s ease, opacity 0.3s ease, border-color 0.3s ease; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border: 1px solid transparent; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; } .btn-login { background-color: #374151; color: white; border-color: #1f2937;} .btn-login:hover { background-color: #1f2937; }
        .btn-primary-app { background-color: #4b5563; color: white; border-color: #374151;} .btn-primary-app:hover:not(:disabled) { background-color: #374151; }
        .btn-success-app { background-color: #16a34a; color: white; border-color: #15803d;} .btn-success-app:hover:not(:disabled) { background-color: #15803d; }
        .btn-danger-app { background-color: #dc2626; color: white; border-color: #b91c1c;} .btn-danger-app:hover:not(:disabled) { background-color: #b91c1c; }
        .btn-warning-app { background-color: #f59e0b; color: black; border-color: #d97706;} .btn-warning-app:hover:not(:disabled) { background-color: #d97706; }
        .btn-small { padding: 0.25rem 0.75rem; font-size: 0.875rem; } .btn-icon { padding: 0.5rem; line-height: 1; } .btn-text-icon { padding: 0.6rem 1rem; }
        .btn-toggle { background-color: #e5e7eb; color: #374151; border-color: #d1d5db; margin-bottom: 0.5rem; } .btn-toggle.active { background-color: #374151; color: white; border-color: #1f2937; box-shadow: 0 2px 4px 0 rgba(0,0,0,0.1); } .btn-toggle:hover:not(:disabled):not(.active) { background-color: #d1d5db; }
        .accordion-item { overflow: hidden; } .accordion-button { background-color: #f9fafb; color: #1f2937; } .accordion-button:hover { background-color: #f3f4f6; } .accordion-button svg { transition: transform 0.3s ease; color: #4b5563; } .accordion-button.open svg { transform: rotate(180deg); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.35s ease-in-out, padding-top 0.35s ease-in-out, padding-bottom 0.35s ease-in-out; padding-top: 0; padding-bottom: 0; background-color: #f9fafb; } .accordion-content.open { padding-top: 1rem; padding-bottom: 1rem; }
        .truly-hidden { display: none !important; } .section-hidden { display: none !important; } #appContainer { padding-top: constant(safe-area-inset-top); padding-top: env(safe-area-inset-top); }
        .number-input-slick, .select-slick { background-color: white; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); padding: 0.5rem 0.75rem; width: 100%; color: #1f2937; } .number-input-slick:focus, .select-slick:focus { outline: none; border-color: #4b5563; box-shadow: 0 0 0 3px rgba(75, 85, 99, 0.2); }
        #settingsTimerMinutes, #settingsTimerSeconds { color: #1f2937; }
        #fullscreenTimerOverlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(31, 41, 55, 0.98); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; padding: 20px; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; } #fullscreenTimerOverlay.visible { opacity: 1; pointer-events: auto; } #fullscreenTimerOverlay #timerDisplayFullscreen { font-size: 6rem; font-weight: bold; color: white; margin-bottom: 1.5rem; } #fullscreenTimerControls { display: flex; gap: 0.75rem; align-items: center; }
        #mainAppContentWrapper.hidden-for-timer { opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        #settingsModal, #cancelDayConfirmationModal, #workoutSummaryModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(55, 65, 81, 0.6); display: flex; align-items: center; justify-content: center; z-index: 150; padding: 1rem; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; } #settingsModal.visible, #cancelDayConfirmationModal.visible, #workoutSummaryModal.visible { opacity: 1; pointer-events: auto; } #settingsModalContent, #cancelDayConfirmationModalContent, #workoutSummaryModalContent { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); width: 100%; max-width: 28rem; border: 1px solid #d1d5db; }
        #minimizedTimerBar { background-color: #475569; color: white; padding: 0.5rem 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.15); transition: background-color 0.2s ease-in-out, opacity 0.3s ease-in-out; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; } #minimizedTimerBar.times-up-flash { background-color: #16a34a; color: white; } #minimizedTimerBarText { font-weight: 600; } #minimizedTimerControls button { background: none; border: none; color: white; padding: 0.25rem; } #minimizedTimerControls button.btn-primary-app, #minimizedTimerControls button.btn-warning-app { color: white; } #minimizedTimerControls button.btn-warning-app { color: black; } #minimizedTimerControls button:hover { color: #d1d5db; }
        .calendar-day { padding: 0.5rem; font-size: 0.8rem; border: 1px solid #e0e0e0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); background-color: #f9fafb; } .calendar-day-name { font-size: 0.65rem; } .calendar-day-date { font-size: 1rem; margin-top: 0.1rem; } .calendar-routine-name { font-size: 0.7rem; min-height: 2rem; line-height: 1.2; margin-top: 0.25rem; } .calendar-day .completion-checkbox { margin-top: 0.25rem; transform: scale(0.9); } .calendar-day label[for^="calDone-"] { font-size: 0.65rem; margin-left: 0.1rem; } .calendar-day .mt-2.flex.items-center.justify-center { margin-top: 0.25rem; }
        .calendar-day.completed { background-color: #d1fae5; border-color: #a1eec6; box-shadow: 0 1px 3px rgba(22, 163, 74, 0.1); } .calendar-day.rest-day .calendar-routine-name { color: #6b7280; font-style: italic; }
        #currentDayInfo, #activeExerciseNameDisplay, #activeExerciseTargetsDisplay, #currentExerciseInDayDisplay, #workoutDurationDisplay, label, #activeSetDisplay, #routinesAccordion > p, #loggedWorkoutsAccordion > p, #bodyWeightLogList > p, #consistencyTrackerWrapper h3, #consistencyTracker p, #personalBestsListEl h4, #muscleGroupFocus h3, #muscleGroupPbsListEl h5, #settingsModalContent h2, #settingsModalContent h3, #settingsModalContent p, #resetConfirmationArea p, #cancelDayConfirmationModalContent h2, #cancelDayConfirmationModalContent p, #workoutSummaryModalContent h2, #workoutSummaryModalContent p, #summaryModalBody span { color: #1f2937; }
        #personalBestsList > p, #muscleGroupPbsList > p { color: #6b7280; font-style: italic; } #settingsModalContent .pt-6 { color: #6b7280; } footer { color: #6b7280; }
        #settingsCogButton { color: #d1d5db; } #settingsCogButton:hover { color: white; } #closeSettingsModalBtn, #closeSummaryModalBtn { color: #9ca3af; } #closeSettingsModalBtn:hover, #closeSummaryModalBtn:hover { color: #4b5563; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loginScreen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 p-4">
         <div class="bg-white p-6 sm:p-10 rounded-xl shadow-2xl w-full max-w-sm text-center border border-gray-200">
            <h3 class="text-2xl font-semibold text-gray-700 mb-2">Hello Nathan</h3>
            <p class="text-gray-500 mb-8">Welcome back!</p>
            <input type="password" id="passwordInput" placeholder="Password" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-6 focus:outline-none focus:ring-2 focus:ring-gray-500 text-lg text-center shadow-sm">
            <button id="loginButton" class="btn btn-login w-full py-3 text-lg">Login</button>
            <p id="loginFeedback" class="text-red-500 text-sm mt-4 h-5"></p>
        </div>
    </div>

    <div id="appContainer" class="truly-hidden">
        <div id="mainAppContentWrapper">
             <header id="appHeader" class="bg-gray-800 text-white p-4 sm:p-6 shadow-lg">
                 <div class="container mx-auto max-w-4xl flex justify-between items-center">
                    <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">FitTrack</h1>
                    <button id="settingsCogButton" class="p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 sm:h-8 sm:w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    </button>
                </div>
             </header>
             <div id="currentDayInfo" class="container mx-auto max-w-4xl p-4 md:px-6 text-center text-sm text-gray-600 font-medium"></div>
             <div id="viewToggleButtons" class="container mx-auto max-w-4xl px-4 md:px-6 flex flex-wrap justify-center space-x-2 sm:space-x-4 mb-2">
                  <button id="showRoutinesBtn" class="btn btn-toggle active">Show Routines</button>
                  <button id="showLogBtn" class="btn btn-toggle">Show Logged Workouts</button>
                  <button id="showCalendarBtn" class="btn btn-toggle">Calendar</button>
                  <button id="showBodyWeightBtn" class="btn btn-toggle">Body Weight</button>
                  <button id="progressBtn" class="btn btn-toggle">Progress</button>
             </div>
             <div id="minimizedTimerBar" class="container mx-auto max-w-4xl truly-hidden rounded-md">
                 <span id="minimizedTimerBarText">Rest Time: 00:00</span>
                 <div id="minimizedTimerControls" class="flex items-center space-x-2"><button id="minimizedPauseResumeBtn" title="Pause/Resume" class="btn btn-icon"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" id="minimizedPlayIconPath"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"  /></svg><svg class="w-5 h-5 truly-hidden" fill="currentColor" viewBox="0 0 20 20" id="minimizedPauseIconPath"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v4a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button><button id="minimizedAdd15sBtn" title="+15 Seconds" class="btn btn-primary-app btn-text-icon text-xs px-2 py-1 font-semibold">+15s</button><button id="minimizedStopBtn" title="Stop Rest" class="btn btn-icon btn-danger-app"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg></button><button id="minimizedMaximizeBtn" title="Maximize Timer" class="btn btn-icon btn-primary-app"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11l7-7 7 7M5 19l7-7 7 7"></path></svg></button></div>
             </div>

            <main class="container mx-auto max-w-4xl p-4 md:p-6 pt-0 md:pt-0 space-y-8">
                <section id="activeWorkoutSection" class="content-section p-6 md:p-8 truly-hidden">
                     <div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-gray-900">Active Workout</h2><button id="showCancelDayConfirmationBtn" class="btn btn-danger-app btn-small py-1 px-2">Cancel Day</button></div>
                     <div id="activeExerciseInfo" class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200"><h3 id="activeExerciseNameDisplay" class="text-xl font-semibold text-gray-800">Exercise Name</h3><p id="activeExerciseTargetsDisplay" class="text-sm text-gray-600">Target: X sets of Y reps</p><p id="currentExerciseInDayDisplay" class="text-xs text-gray-500 mt-1">Exercise X of Y for the day</p><p id="workoutDurationDisplay" class="text-sm text-gray-600 mt-1 font-medium">Session Duration: 00:00</p></div>
                     <div class="space-y-4"><div><label for="activeWorkoutDate" class="block text-sm font-medium text-gray-700">Workout Date</label><input type="date" id="activeWorkoutDate" name="activeWorkoutDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500 sm:text-sm text-gray-800"></div><div id="weightInputGroup"><label for="activeWeightInput" class="block text-sm font-medium text-gray-700 mb-1">Weight (<span id="activeUnitDisplayValue" class="text-gray-700">kg</span>)</label><input type="number" id="activeWeightInput" inputmode="decimal" min="0" step="0.1" value="0" class="number-input-slick mt-1"></div><div id="unitInputGroup"><label for="activeUnitInput" class="block text-sm font-medium text-gray-700">Unit</label><select id="activeUnitInput" class="select-slick mt-1"><option value="kg">kg</option><option value="lbs">lbs</option></select></div><div id="durationInputGroup" class="truly-hidden"><label for="activeDurationInput" id="activeDurationLabel" class="block text-sm font-medium text-gray-700 mb-1">Duration (seconds)</label><input type="number" id="activeDurationInput" inputmode="numeric" min="1" step="1" value="30" class="number-input-slick mt-1"></div><div id="rpeInputGroup" class="truly-hidden"><label for="activeRpeSelect" class="block text-sm font-medium text-gray-700">Perceived Exertion (RPE)</label><select id="activeRpeSelect" class="select-slick mt-1"><option value="">- Select RPE -</option><option value="Easy">Easy</option><option value="Medium">Medium</option><option value="Hard">Hard</option><option value="Extreme">Extreme</option></select></div><p id="activeSetDisplay" class="text-md font-medium text-gray-700 text-center my-2">Set: 1 / 3</p><div><label for="activeNotesInput" class="block text-sm font-medium text-gray-700">Notes (optional)</label><textarea id="activeNotesInput" rows="2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-gray-500 focus:border-gray-500 sm:text-sm text-gray-800" placeholder="e.g., Felt strong, focus on form..."></textarea></div><div class="flex space-x-3 mt-6"><button id="logSetButton" class="flex-1 btn btn-primary-app font-semibold py-2 px-4 rounded-md shadow-md">Log Set & Rest</button><button id="finishExerciseButton" class="flex-1 btn btn-success-app font-semibold py-2 px-4 rounded-md shadow-md">Finish Exercise & Next</button></div></div>
                     <div id="activeWorkoutFeedback" class="mt-4 text-sm h-5"></div>
                </section>

                <section id="workout-routines-section" class="content-section p-6 md:p-8">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-900">Workout Routines</h2>
                    <div id="routinesAccordion" class="space-y-3"><p class="text-gray-500 italic">Loading routines...</p></div>
                </section>

                <section id="calendar-section" class="content-section p-6 md:p-8 section-hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-900">Weekly Schedule</h2>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
                    <p class="text-xs text-gray-500 mt-4 italic">This calendar shows your scheduled routines...</p>
                </section>

                <section id="workout-list-section" class="content-section p-6 md:p-8 section-hidden">
                     <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-semibold text-gray-900">Logged Workouts</h2></div>
                     <div id="loggedWorkoutsAccordion" class="space-y-3"><p class="text-gray-500 italic">No workouts logged yet.</p></div>
                </section>

                <section id="body-weight-section" class="content-section p-6 md:p-8 section-hidden">
                     <h2 class="text-2xl font-semibold mb-6 text-gray-900">Body Weight Log</h2>
                     <form id="bodyWeightForm" class="space-y-4 mb-8"><div class="grid grid-cols-1 sm:grid-cols-3 gap-4"><div><label for="bodyWeightInput" class="block text-sm font-medium text-gray-700">Weight</label><input type="number" id="bodyWeightInput" inputmode="decimal" step="0.1" required class="number-input-slick mt-1"></div><div><label for="bodyWeightUnit" class="block text-sm font-medium text-gray-700">Unit</label><select id="bodyWeightUnit" class="select-slick mt-1"><option value="kg">kg</option><option value="lbs">lbs</option></select></div><div><label for="bodyWeightDate" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="bodyWeightDate" required class="number-input-slick mt-1"></div></div><button type="submit" class="btn btn-primary-app w-full sm:w-auto">Log Body Weight</button></form>
                     <div id="bodyWeightLogList" class="space-y-3"><p class="text-gray-500 italic">No body weight logged yet.</p></div>
                     <p id="bodyWeightFeedback" class="mt-4 text-sm h-5"></p>
                </section>

                <section id="progress-section" class="content-section p-6 md:p-8 section-hidden">
                    <h2 class="text-2xl font-semibold mb-6 text-gray-900">Progress</h2>
                    <div id="consistencyTrackerWrapper" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm"><h3 class="text-lg font-semibold text-gray-800 mb-2">Workout Consistency</h3><div id="consistencyTracker" class=""><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center"><div><p class="text-2xl font-bold text-gray-700" id="currentStreakDisplay">0</p><p class="text-xs text-gray-500">Current Streak (Days)</p></div><div><p class="text-2xl font-bold text-gray-700" id="workoutsThisWeekDisplay">0</p><p class="text-xs text-gray-500">Workouts This Week</p></div><div><p class="text-2xl font-bold text-gray-700" id="longestStreakDisplay">0</p><p class="text-xs text-gray-500">Longest Streak (Days)</p></div></div></div><p id="motivationalMessage" class="text-sm text-center text-gray-600 mt-4 italic"></p></div>
                     <div class="accordion-item mb-6 border border-gray-200 rounded-lg shadow-sm"><button id="togglePBsBtn" class="accordion-button w-full flex justify-between items-center p-4 text-left"><span class="font-medium">Personal Bests (PBs)</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="personalBestsList" class="accordion-content p-4 space-y-4"><p class="text-gray-500 italic">No workouts logged yet.</p></div></div>
                     <div class="accordion-item border border-gray-200 rounded-lg shadow-sm"><button id="toggleMuscleFocusBtn" class="accordion-button w-full flex justify-between items-center p-4 text-left"><span class="font-medium">Muscle Group Focus (Based on PBs)</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button><div id="muscleGroupPbsList" class="accordion-content p-4 space-y-4"><p class="text-gray-500 italic">Log workouts to see.</p></div></div>
                </section>
            </main>

            <footer class="text-center p-6 mt-10 text-gray-600 text-sm">
                <p>Â© <span id="currentYear"></span> FitTrack. Keep Pushing!</p>
            </footer>
        </div>
    </div>

    <div id="settingsModal" class="truly-hidden">
        <div id="settingsModalContent">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-900">Settings</h2>
                <button id="closeSettingsModalBtn"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Timer Settings</h3>
                <p class="text-sm text-gray-600 mb-4">Set your default rest period duration.</p>
                <div class="space-y-4">
                    <div class="flex items-center space-x-3">
                        <div class="flex-1"><label for="settingsTimerMinutes" class="block text-sm font-medium text-gray-700">Minutes</label><input type="number" id="settingsTimerMinutes" min="0" max="59" class="number-input-slick mt-1 text-center"></div>
                        <span class="pt-6 text-xl font-semibold text-gray-500">:</span>
                        <div class="flex-1"><label for="settingsTimerSeconds" class="block text-sm font-medium text-gray-700">Seconds</label><input type="number" id="settingsTimerSeconds" min="0" max="59" class="number-input-slick mt-1 text-center"></div>
                    </div>
                    <button id="saveTimerSettingsBtn" class="btn btn-primary-app w-full py-2.5">Save Timer Settings</button>
                </div>
            </div>
            <hr class="my-6 border-gray-200">
            <div class="mb-6">
                 <h3 class="text-lg font-medium text-gray-900 mb-2">Notifications</h3>
                 <button id="requestNotificationPermissionBtn" class="btn btn-primary-app w-full py-2.5">Request Notification Permission</button>
                 <p id="notificationPermissionStatus" class="text-xs text-gray-500 mt-2"></p>
            </div>
            <hr class="my-6 border-gray-200">
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Data Management</h3>
                <button id="exportDataBtn" class="btn btn-primary-app w-full py-2.5 mb-3">Export All App Data</button>
                <div>
                    <label for="importFile" class="block text-sm font-medium text-gray-700 mb-1">Import App Data (.json)</label>
                    <input type="file" id="importFile" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-gray-200 file:text-gray-700 hover:file:bg-gray-300 cursor-pointer"/>
                    <button id="importDataBtn" class="btn btn-primary-app w-full py-2.5 mt-2">Import Selected File</button>
                </div>
            </div>
            <hr class="my-6 border-gray-200">
            <div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Reset App Data</h3>
                <p class="text-sm text-gray-600 mb-3">This will delete all logged workouts and reset timer settings to default.</p>
                <button id="showResetConfirmationBtn" class="btn btn-danger-app w-full py-2.5">Reset All App Data</button>
                <div id="resetConfirmationArea" class="mt-3 p-3 bg-red-50 border border-red-200 rounded-md truly-hidden">
                    <p class="text-sm text-red-700 mb-3">Are you sure? This action cannot be undone.</p>
                    <div class="flex space-x-3"><button id="confirmResetBtn" class="btn btn-danger-app flex-1">Yes, Reset Data</button><button id="cancelResetBtn" class="btn btn-primary-app flex-1">No, Cancel</button></div>
                </div>
            </div>
            <p id="settingsFeedback" class="text-sm mt-4 h-5"></p>
        </div>
    </div>
    <div id="cancelDayConfirmationModal" class="truly-hidden"><div id="cancelDayConfirmationModalContent"><h2 class="text-xl font-semibold text-gray-900 mb-4">Cancel Workout Day?</h2><p class="text-sm text-gray-600 mb-6">Are you sure you want to cancel the current workout day? Any unsaved progress for the current exercise will be lost.</p><div class="flex justify-end space-x-3"><button id="confirmCancelDayBtn" class="btn btn-danger-app">Yes, Cancel Day</button><button id="dontCancelDayBtn" class="btn btn-primary-app">No, Continue</button></div></div></div>
    <div id="workoutSummaryModal" class="truly-hidden"><div id="workoutSummaryModalContent"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-semibold text-gray-900" id="summaryModalTitle">Workout Completed!</h2><button id="closeSummaryModalBtn"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div id="summaryModalBody" class="text-sm text-gray-600 space-y-2"><p>Total Exercises: <span id="summaryTotalExercises" class="font-medium text-gray-700">0</span></p><p>Total Sets Logged: <span id="summaryTotalSets" class="font-medium text-gray-700">0</span></p><p>Session Duration: <span id="summarySessionDuration" class="font-medium text-gray-700">00:00</span></p><p class="mt-4 font-semibold text-green-600">Great work, Nathan! Keep it up!</p></div><div class="mt-6 flex justify-end"><button id="okSummaryModalBtn" class="btn btn-success-app">Great!</button></div></div></div>
    <div id="fullscreenTimerOverlay" class="truly-hidden"><div id="timerDisplayFullscreen" class="text-7xl sm:text-8xl font-bold text-white">00:00</div><div id="fullscreenTimerControls" class="mt-6"><button id="fullscreenPauseResumeBtn" class="btn btn-icon p-3"><svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20" id="fullscreenPlayIcon"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg><svg class="w-7 h-7 truly-hidden" fill="currentColor" viewBox="0 0 20 20" id="fullscreenPauseIcon"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v4a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button><button id="fullscreenAdd15sBtn" class="btn btn-primary-app btn-text-icon font-semibold p-3" title="+15 Seconds">+15s</button><button id="fullscreenStopBtn" class="btn btn-danger-app btn-icon p-3" title="Stop Rest & Workout"><svg class="w-7 h-7" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg></button><button id="fullscreenMinimizeBtn" class="btn btn-primary-app btn-icon p-3" title="Minimize Timer"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 13l-7 7-7-7m14-4l-7 7-7-7" /></svg></button></div></div>

    <script>
        // Wrap entire script in a try...catch for better error visibility
        try {
            console.log("FitTrack Script: Starting execution.");

            document.addEventListener('DOMContentLoaded', () => {
                console.log("FitTrack Script: DOMContentLoaded event fired.");

                // --- DOM Elements (ensure all are checked) ---
                const loginScreen = document.getElementById('loginScreen');
                const appContainer = document.getElementById('appContainer');
                const mainAppContentWrapper = document.getElementById('mainAppContentWrapper');
                const appHeader = document.getElementById('appHeader'); // Added for potential feedback
                const passwordInput = document.getElementById('passwordInput');
                const loginButton = document.getElementById('loginButton');
                const loginFeedback = document.getElementById('loginFeedback');
                const currentDayInfo = document.getElementById('currentDayInfo');
                const routinesAccordionEl = document.getElementById('routinesAccordion');
                const calendarGridEl = document.getElementById('calendarGrid');
                const calendarSection = document.getElementById('calendar-section');
                const loggedWorkoutsAccordionEl = document.getElementById('loggedWorkoutsAccordion');
                const activeWorkoutSection = document.getElementById('activeWorkoutSection');
                const activeExerciseNameDisplay = document.getElementById('activeExerciseNameDisplay');
                const activeExerciseTargetsDisplay = document.getElementById('activeExerciseTargetsDisplay');
                const currentExerciseInDayDisplay = document.getElementById('currentExerciseInDayDisplay');
                const activeWorkoutDateInput = document.getElementById('activeWorkoutDate');
                const workoutDurationDisplay = document.getElementById('workoutDurationDisplay');
                const activeWeightInput = document.getElementById('activeWeightInput');
                const activeWeightInputGroup = document.getElementById('weightInputGroup');
                const activeDurationInputGroup = document.getElementById('durationInputGroup');
                const activeDurationInput = document.getElementById('activeDurationInput');
                const activeDurationLabel = document.getElementById('activeDurationLabel');
                const activeUnitDisplayValue = document.getElementById('activeUnitDisplayValue');
                const activeUnitInput = document.getElementById('activeUnitInput');
                const unitInputGroup = document.getElementById('unitInputGroup');
                const rpeInputGroup = document.getElementById('rpeInputGroup');
                const activeRpeSelect = document.getElementById('activeRpeSelect');
                const activeSetDisplay = document.getElementById('activeSetDisplay');
                const activeNotesInput = document.getElementById('activeNotesInput');
                const logSetButton = document.getElementById('logSetButton');
                const finishExerciseButton = document.getElementById('finishExerciseButton');
                const showCancelDayConfirmationBtn = document.getElementById('showCancelDayConfirmationBtn');
                const activeWorkoutFeedback = document.getElementById('activeWorkoutFeedback');
                const settingsCogButton = document.getElementById('settingsCogButton');
                const settingsModal = document.getElementById('settingsModal');
                const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
                const settingsTimerMinutesInput = document.getElementById('settingsTimerMinutes');
                const settingsTimerSecondsInput = document.getElementById('settingsTimerSeconds');
                const saveTimerSettingsBtn = document.getElementById('saveTimerSettingsBtn');
                const requestNotificationPermissionBtn = document.getElementById('requestNotificationPermissionBtn'); // Added
                const notificationPermissionStatus = document.getElementById('notificationPermissionStatus'); // Added
                const settingsFeedback = document.getElementById('settingsFeedback');
                const showResetConfirmationBtn = document.getElementById('showResetConfirmationBtn');
                const resetConfirmationArea = document.getElementById('resetConfirmationArea');
                const confirmResetBtn = document.getElementById('confirmResetBtn');
                const cancelResetBtn = document.getElementById('cancelResetBtn');
                const exportDataBtn = document.getElementById('exportDataBtn');
                const importFileEl = document.getElementById('importFile');
                const importDataBtn = document.getElementById('importDataBtn');
                const cancelDayConfirmationModal = document.getElementById('cancelDayConfirmationModal');
                const confirmCancelDayBtn = document.getElementById('confirmCancelDayBtn');
                const dontCancelDayBtn = document.getElementById('dontCancelDayBtn');
                const workoutSummaryModal = document.getElementById('workoutSummaryModal');
                const summaryModalTitle = document.getElementById('summaryModalTitle');
                const summaryTotalExercises = document.getElementById('summaryTotalExercises');
                const summaryTotalSets = document.getElementById('summaryTotalSets');
                const summarySessionDuration = document.getElementById('summarySessionDuration');
                const okSummaryModalBtn = document.getElementById('okSummaryModalBtn');
                const closeSummaryModalBtn = document.getElementById('closeSummaryModalBtn');
                const fullscreenTimerOverlay = document.getElementById('fullscreenTimerOverlay');
                const timerDisplayFullscreen = document.getElementById('timerDisplayFullscreen');
                const fullscreenPauseResumeBtn = document.getElementById('fullscreenPauseResumeBtn');
                const fullscreenPlayIcon = document.getElementById('fullscreenPlayIcon');
                const fullscreenPauseIcon = document.getElementById('fullscreenPauseIcon');
                const fullscreenAdd15sBtn = document.getElementById('fullscreenAdd15sBtn');
                const fullscreenStopBtn = document.getElementById('fullscreenStopBtn');
                const fullscreenMinimizeBtn = document.getElementById('fullscreenMinimizeBtn');
                const minimizedTimerBar = document.getElementById('minimizedTimerBar');
                const minimizedTimerBarText = document.getElementById('minimizedTimerBarText');
                const minimizedPauseResumeBtn = document.getElementById('minimizedPauseResumeBtn');
                const minimizedPlayIconPath = document.getElementById('minimizedPlayIconPath');
                const minimizedPauseIconPath = document.getElementById('minimizedPauseIconPath');
                const minimizedAdd15sBtn = document.getElementById('minimizedAdd15sBtn');
                const minimizedStopBtn = document.getElementById('minimizedStopBtn');
                const minimizedMaximizeBtn = document.getElementById('minimizedMaximizeBtn');
                const viewToggleButtons = document.getElementById('viewToggleButtons');
                const showRoutinesBtn = document.getElementById('showRoutinesBtn');
                const showLogBtn = document.getElementById('showLogBtn');
                const showCalendarBtn = document.getElementById('showCalendarBtn');
                const progressBtn = document.getElementById('progressBtn');
                const showBodyWeightBtn = document.getElementById('showBodyWeightBtn');
                const workoutRoutinesSection = document.getElementById('workout-routines-section');
                const workoutListSection = document.getElementById('workout-list-section');
                const bodyWeightSection = document.getElementById('body-weight-section');
                const bodyWeightForm = document.getElementById('bodyWeightForm');
                const bodyWeightInputEl = document.getElementById('bodyWeightInput');
                const bodyWeightUnitEl = document.getElementById('bodyWeightUnit');
                const bodyWeightDateEl = document.getElementById('bodyWeightDate');
                const bodyWeightLogList = document.getElementById('bodyWeightLogList');
                const bodyWeightFeedback = document.getElementById('bodyWeightFeedback');
                const progressSection = document.getElementById('progress-section');
                const personalBestsListEl = document.getElementById('personalBestsList');
                const muscleGroupPbsListEl = document.getElementById('muscleGroupPbsList');
                const currentStreakDisplay = document.getElementById('currentStreakDisplay');
                const workoutsThisWeekDisplay = document.getElementById('workoutsThisWeekDisplay');
                const longestStreakDisplay = document.getElementById('longestStreakDisplay');
                const motivationalMessageEl = document.getElementById('motivationalMessage');
                const togglePBsBtn = document.getElementById('togglePBsBtn');
                const toggleMuscleFocusBtn = document.getElementById('toggleMuscleFocusBtn');

                // --- App State ---
                let activeWorkoutState = null; let currentDayRoutine = null; let currentExerciseIndex = -1;
                let defaultRestMinutes = 1; let defaultRestSeconds = 30;
                let workoutSessionStartTime = null; let workoutDurationInterval = null; let totalSetsThisSession = 0;
                let timerInterval; let remainingSecondsForCountdown = 0; let restTimerState = 'idle'; // idle, running, paused, finished
                let isTimerMinimized = false;

                // --- Workout Routines Data (Keep as is) ---
                const workoutRoutinesData = [
                    { day: "Day 1: Chest & Triceps", exercises: [ { name: "Barbell Bench Press (or dumbbell)", sets: 3, reps: "10-12", why: "Primary chest builder...", muscleGroup: "Chest", type: "weight" }, { name: "Incline Dumbbell Press", sets: 3, reps: "10-12", why: "Targets upper chest...", muscleGroup: "Chest", type: "weight" }, { name: "Dumbbell Flyes (or band chest fly)", sets: 2, reps: "12-15", why: "Isolates chest muscles...", muscleGroup: "Chest", type: "weight" }, { name: "Overhead Tricep Extension (dumbbell/band)", sets: 3, reps: "12", why: "Works all three heads of triceps...", muscleGroup: "Triceps", type: "weight" }, { name: "Tricep Dips (bench/parallel bars)", sets: 2, reps: "10-12", why: "Compound tricep movement...", muscleGroup: "Triceps", type: "weight" } ]},
                    { day: "Day 2: Back & Biceps", exercises: [ { name: "Bent-Over Dumbbell Row", sets: 3, reps: "10-12", why: "Builds back thickness...", muscleGroup: "Back", type: "weight" }, { name: "Assisted Pull-Ups (or inverted rows)", sets: 3, reps: "8-10", why: "Excellent for back width...", muscleGroup: "Back", type: "weight" }, { name: "Lat Pulldown (or extra dumbbell row)", sets: 3, reps: "10-12", why: "Mimics pull-ups...", muscleGroup: "Back", type: "weight" }, { name: "Dumbbell Bicep Curl", sets: 3, reps: "12", why: "Classic bicep builder...", muscleGroup: "Biceps", type: "weight" }, { name: "Hammer Curls (dumbbells/bands)", sets: 2, reps: "12-15", why: "Targets brachialis...", muscleGroup: "Biceps", type: "weight" } ]},
                    { day: "Day 3: Legs & Glutes", exercises: [ { name: "Leg Press (machine or dumbbell sumo squat)", sets: 3, reps: "10-12", why: "Targets quads, glutes...", muscleGroup: "Legs", type: "weight" }, { name: "Seated Leg Curl (machine or dumbbell stiff-leg deadlift)", sets: 3, reps: "12", why: "Focuses on hamstrings...", muscleGroup: "Hamstrings", type: "weight" }, { name: "Leg Extension (machine or bodyweight step-ups)", sets: 3, reps: "10-12", why: "Isolates quads...", muscleGroup: "Quads", type: "weight" }, { name: "Hip Thrust (barbell or dumbbell)", sets: 3, reps: "12-15", why: "Glute-focused...", muscleGroup: "Glutes", type: "weight" }, { name: "Seated Calf Raise (machine or dumbbell)", sets: 2, reps: "15-20", why: "Isolates calves...", muscleGroup: "Calves", type: "weight" } ]},
                    { day: "Day 4: Shoulders & Core", exercises: [ { name: "Seated Dumbbell Shoulder Press", sets: 3, reps: "10-12", why: "Builds shoulder mass...", muscleGroup: "Shoulders", type: "weight" }, { name: "Lateral Raises (dumbbells/bands)", sets: 3, reps: "12-15", why: "Isolates medial deltoids...", muscleGroup: "Shoulders", type: "weight" }, { name: "Front Raises (dumbbells/bands)", sets: 2, reps: "12", why: "Targets anterior deltoids...", muscleGroup: "Shoulders", type: "weight" }, { name: "Plank", sets: 3, reps: "20-30 sec", why: "Core stability... Reps = seconds for timed.", muscleGroup: "Core", type: "timed" }, { name: "Russian Twists (with/without weight)", sets: 3, reps: "15 reps/side", why: "Targets obliques...", muscleGroup: "Core", type: "weight" } ]},
                    { day: "Day 5: Full-Body", exercises: [ { name: "Bodyweight Squats", sets: 3, reps: "12-15", why: "Fundamental compound movement...", muscleGroup: "Legs", type: "weight" }, { name: "Barbell Bench Press (or dumbbell)", sets: 3, reps: "10-12", why: "Primary chest builder...", muscleGroup: "Chest", type: "weight" }, { name: "Single-Arm Dumbbell Row", sets: 3, reps: "10 reps/arm", why: "Unilateral back exercise...", muscleGroup: "Back", type: "weight" }, { name: "Dumbbell Shoulder Press", sets: 2, reps: "10-12", why: "Compound shoulder exercise...", muscleGroup: "Shoulders", type: "weight" }, { name: "Bicycle Crunches", sets: 3, reps: "15 reps/side", why: "Effective core exercise...", muscleGroup: "Core", type: "reps" } ]}
                ];

                // --- Utility Functions (Keep as is) ---
                function showUserFeedback(element, message, type, duration = 3000) { if (!element) { console.warn("showUserFeedback: Target element not found for message:", message); return; } element.textContent = message; element.className = `text-sm mt-4 ${type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-500' : 'text-gray-600'}`; if (duration > 0) { setTimeout(() => { if (element.textContent === message) { element.textContent = ''; element.className = 'text-sm mt-4 h-5'; } }, duration); } }
                function setDefaultDate(dateInputElement) { if (dateInputElement && !dateInputElement.value) { const today = new Date(); const y = today.getFullYear(); const m = String(today.getMonth() + 1).padStart(2, '0'); const d = String(today.getDate()).padStart(2, '0'); dateInputElement.value = `${y}-${m}-${d}`; } }

                // --- Local Storage Functions (Keep as is) ---
                function loadWorkouts() { try { return JSON.parse(localStorage.getItem('fitTrackWorkouts') || '[]'); } catch(e) { console.error("Error loading workouts:", e); return []; } }
                function saveWorkouts(workouts) { localStorage.setItem('fitTrackWorkouts', JSON.stringify(workouts)); }
                function loadBodyWeights() { try { return JSON.parse(localStorage.getItem('fitTrackBodyWeights') || '[]'); } catch(e) { console.error("Error loading body weights:", e); return []; } }
                function saveBodyWeights(weights) { localStorage.setItem('fitTrackBodyWeights', JSON.stringify(weights)); }
                function loadCompletedDays() { try { return JSON.parse(localStorage.getItem('fitTrackCompletedDays') || '{}'); } catch(e) { console.error("Error loading completed days:", e); return {}; } }
                function saveCompletedDays(completedDays) { localStorage.setItem('fitTrackCompletedDays', JSON.stringify(completedDays)); }

                // --- Accordion / Rendering Functions (Keep mostly as is, check delete function context) ---
                function setupAccordionToggle(buttonEl, contentEl, startOpen = false) { if (!buttonEl || !contentEl) { return; } const svgIcon = buttonEl.querySelector('svg'); function toggle() { const isOpen = contentEl.classList.contains('open'); buttonEl.classList.toggle('open', !isOpen); if (svgIcon) { svgIcon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)'; } if (!isOpen) { contentEl.classList.add('open'); contentEl.style.maxHeight = contentEl.scrollHeight + 'px'; } else { contentEl.style.maxHeight = '0px'; const transitionEndHandler = () => { if (!buttonEl.classList.contains('open')) { contentEl.classList.remove('open'); } contentEl.removeEventListener('transitionend', transitionEndHandler); }; contentEl.addEventListener('transitionend', transitionEndHandler); } } if (startOpen) { buttonEl.classList.add('open'); contentEl.classList.add('open'); if (svgIcon) svgIcon.style.transform = 'rotate(180deg)'; requestAnimationFrame(() => { if (contentEl.classList.contains('open')) { contentEl.style.maxHeight = contentEl.scrollHeight + 'px'; }}); } else { contentEl.style.maxHeight = '0px'; contentEl.classList.remove('open'); if (svgIcon) svgIcon.style.transform = 'rotate(0deg)'; } buttonEl.addEventListener('click', toggle); }
                function renderLoggedWorkoutsAccordion() { if (!loggedWorkoutsAccordionEl) return; const workouts = loadWorkouts(); loggedWorkoutsAccordionEl.innerHTML = ''; if (workouts.length === 0) { loggedWorkoutsAccordionEl.innerHTML = '<p class="text-gray-500 italic">No workouts logged yet.</p>'; return; } const workoutsByDate = workouts.reduce((acc, workout) => { const date = workout.date; if (!acc[date]) acc[date] = []; acc[date].push(workout); return acc; }, {}); const sortedDates = Object.keys(workoutsByDate).sort((a, b) => new Date(b) - new Date(a)); if (sortedDates.length === 0) { loggedWorkoutsAccordionEl.innerHTML = '<p class="text-gray-500 italic">No workouts logged yet.</p>'; return; } sortedDates.forEach(date => { const accordionItem = document.createElement('div'); accordionItem.className = 'accordion-item border border-gray-200 rounded-lg shadow-sm'; const button = document.createElement('button'); button.className = 'accordion-button w-full flex justify-between items-center p-4 text-left'; button.innerHTML = `<span class="font-medium">${new Date(date + 'T00:00:00').toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}</span><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`; const content = document.createElement('div'); content.className = 'accordion-content'; const workoutListForDate = document.createElement('div'); workoutListForDate.className = 'space-y-3 p-4'; workoutsByDate[date].sort((a,b) => b.id - a.id).forEach(workout => { const workoutItem = document.createElement('div'); workoutItem.className = 'bg-gray-50 p-3 rounded-md border border-gray-100'; let detailsHtml = `<div class="flex justify-between items-start"><h4 class="text-md font-semibold text-gray-700">${workout.exercise}</h4><button onclick="deleteWorkout(${workout.id})" class="btn btn-danger-app btn-small text-xs p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div><div class="mt-1 text-sm text-gray-600 grid grid-cols-2 sm:grid-cols-3 gap-2"><span>S: ${workout.sets}</span>`; if (workout.type === 'timed') { detailsHtml += `<span>Duration: ${workout.reps}</span>`; } else if (workout.type === 'reps') { detailsHtml += `<span>R: ${workout.reps}</span>`; } else { detailsHtml += `<span>R: ${workout.reps}</span> <span>W: ${workout.weight} ${workout.unit}</span>`; } detailsHtml += `</div>`; if (workout.rpe) { detailsHtml += `<p class="text-xs text-gray-500 mt-1">RPE: ${workout.rpe}</p>`; } if(workout.notes) { detailsHtml += `<p class="text-xs text-gray-500 mt-2"><em>Notes: ${workout.notes}</em></p>`; } workoutItem.innerHTML = detailsHtml; workoutListForDate.appendChild(workoutItem); }); content.appendChild(workoutListForDate); accordionItem.appendChild(button); accordionItem.appendChild(content); loggedWorkoutsAccordionEl.appendChild(accordionItem); setupAccordionToggle(button, content); }); }
                // Make sure deleteWorkout is globally accessible
                window.deleteWorkout = function(workoutId) { let workouts = loadWorkouts(); workouts = workouts.filter(workout => workout.id !== workoutId); saveWorkouts(workouts); renderLoggedWorkoutsAccordion(); renderProgress(); showUserFeedback(activeWorkoutFeedback || settingsFeedback || appHeader, 'Workout deleted.', 'success'); } // Added appHeader as potential feedback spot

                function renderWorkoutRoutines() { /* Keep as is */ }
                function renderWeeklyCalendarView() { /* Keep as is */ }
                window.handleMarkDayAsDone = function(dateString, isChecked) { /* Keep as is */ }
                function renderBodyWeightLog() { /* Keep as is */ }
                window.deleteBodyWeightEntry = function(entryId) { /* Keep as is */ }
                function renderProgress() { /* Keep as is */ }

                // --- Day Routine & Active Exercise (Keep as is) ---
                function startDayRoutine(dayIndex) { /* Keep as is */ }
                function updateWorkoutDurationDisplay() { /* Keep as is */ }
                function startNextExerciseInDay() { /* Keep as is */ }
                function handleFinishExercise() { /* Keep as is */ }
                function finishDayRoutine() { /* Keep as is */ }
                function resetActiveWorkoutSessionUI(showCancelMsg = true) { /* Keep as is */ }
                function showCancelDayConfirmation() { /* Keep as is */ }
                function hideCancelDayConfirmation() { /* Keep as is */ }
                function confirmCancelDayAction() { /* Keep as is */ }
                function cancelCurrentDayRoutine() { /* Keep as is */ }

                // --- Notification Permission Logic ---
                function updateNotificationStatusDisplay() {
                    if (!('Notification' in window)) {
                        if(notificationPermissionStatus) notificationPermissionStatus.textContent = "Notifications not supported by this browser.";
                        if(requestNotificationPermissionBtn) requestNotificationPermissionBtn.disabled = true;
                        return;
                    }
                    const currentPermission = Notification.permission;
                     if(notificationPermissionStatus) notificationPermissionStatus.textContent = `Current status: ${currentPermission}`;
                    if(requestNotificationPermissionBtn) requestNotificationPermissionBtn.disabled = (currentPermission !== 'default'); // Disable if already granted or denied
                }

                function requestNotificationPermission() {
                    if (!('Notification' in window)) {
                        showUserFeedback(settingsFeedback || appHeader, "Notifications not supported.", "error");
                        return;
                    }
                    if (Notification.permission === 'granted') {
                         showUserFeedback(settingsFeedback || appHeader, "Notifications already granted.", "success");
                         updateNotificationStatusDisplay();
                         return;
                    }
                    if (Notification.permission === 'denied') {
                         showUserFeedback(settingsFeedback || appHeader, "Notifications previously denied. Check browser/OS settings.", "warning");
                         updateNotificationStatusDisplay();
                         return;
                    }
                    if (Notification.permission === 'default') {
                        console.log('Main Script: Requesting notification permission...');
                        Notification.requestPermission().then(permission => {
                            console.log('Main Script: Notification permission result:', permission);
                            if (permission === "granted") {
                                showUserFeedback(settingsFeedback || appHeader, "Notifications enabled!", "success", 2000);
                            } else {
                                showUserFeedback(settingsFeedback || appHeader, "Notifications denied.", "warning", 4000);
                            }
                            updateNotificationStatusDisplay(); // Update display after request
                        }).catch(err => {
                             console.error("Error requesting notification permission:", err);
                             showUserFeedback(settingsFeedback || appHeader, "Error requesting permissions.", "error");
                        });
                    }
                }


                // --- Timer Logic Definitions (Keep mostly as is) ---
                function updateTimerDisplays() { /* Keep as is */ }
                function startRestTimerVisuals() { /* Keep as is */ }
                function handleZeroRestScenario() { /* Keep as is */ }
                function pauseRestTimer() { /* Keep as is */ }
                function resumeRestTimer() { /* Keep as is */ }
                function add15SecondsToRest() { /* Keep as is */ }
                function stopAndHideRestTimer(stoppedByUser = true) { /* Keep as is, ensure SW message logic is correct */ }
                function endRestTimerExperience() { /* Keep as is */ }
                function handleMinimizeTimer() { /* Keep as is */ }
                function handleMaximizeTimer() { /* Keep as is */ }
                function updateFullscreenPauseResumeButton(isPaused) { /* Keep as is */ }
                function updateMinimizedPauseResumeButton(isPaused) { /* Keep as is */ }

                // --- Core Action Functions (Add logging) ---
                function handleLogSet() {
                    console.log("Main Script: handleLogSet called."); // *** DEBUG Log start ***
                    if (!activeWorkoutState) { console.error("handleLogSet - activeWorkoutState is null. Aborting."); return; }
                    let feedbackMessage = `Set ${activeWorkoutState.currentSet} noted. `;

                    // --- Input Validation ---
                    if (activeWorkoutState.type === 'timed') {
                        if (!activeDurationInput) { console.error("handleLogSet - activeDurationInput is null!"); return; }
                        const duration = parseInt(activeDurationInput.value);
                        if (isNaN(duration) || duration <=0) { showUserFeedback(activeWorkoutFeedback, 'Enter valid duration.', 'error'); if(activeDurationInput) activeDurationInput.focus(); return; }
                        activeWorkoutState.lastWeightOrDuration = duration;
                        feedbackMessage = `Set ${activeWorkoutState.currentSet} (${duration} sec) noted. `;
                    } else if (activeWorkoutState.type === 'weight') {
                        if (!activeWeightInput) { console.error("handleLogSet - activeWeightInput is null!"); return; }
                        const weight = parseFloat(activeWeightInput.value);
                        if (isNaN(weight) || weight < 0) { showUserFeedback(activeWorkoutFeedback, 'Enter valid weight.', 'error'); if(activeWeightInput) activeWeightInput.focus(); return; }
                        activeWorkoutState.lastWeightOrDuration = weight;
                        if(activeUnitInput) activeWorkoutState.unit = activeUnitInput.value;
                        feedbackMessage = `Set ${activeWorkoutState.currentSet} (${weight}${activeWorkoutState.unit}) noted. `;
                    }
                    // No weight/duration needed for type 'reps'

                    activeWorkoutState.notes = activeNotesInput ? activeNotesInput.value : '';
                    totalSetsThisSession++; // Increment *before* scheduling rest
                    console.log("Main Script: Total sets this session:", totalSetsThisSession); // *** DEBUG Log set count ***

                    // --- Update UI for next set / finish ---
                    if (activeWorkoutState.currentSet < activeWorkoutState.targetSets) {
                        activeWorkoutState.currentSet++;
                        if(activeSetDisplay) activeSetDisplay.textContent = `Set: ${activeWorkoutState.currentSet} / ${activeWorkoutState.targetSets}`;
                    } else {
                        if(activeSetDisplay) activeSetDisplay.textContent = `All sets noted! Finish exercise.`;
                        if(logSetButton) logSetButton.disabled = true; // Disable log set if all done
                        if(finishExerciseButton) finishExerciseButton.focus();
                    }

                    // Disable buttons while timer runs
                    if(logSetButton) logSetButton.disabled = true;
                    if(finishExerciseButton) finishExerciseButton.disabled = true;

                    // --- Timer Scheduling ---
                    const currentTotalRestSeconds = (defaultRestMinutes * 60) + defaultRestSeconds;
                    console.log("Main Script: Calculated total rest seconds:", currentTotalRestSeconds); // *** DEBUG Log rest time ***

                    if (currentTotalRestSeconds <= 0) {
                        showUserFeedback(activeWorkoutFeedback, feedbackMessage + "Rest time is 0. Skipping rest.", "info");
                        handleZeroRestScenario(); // Make sure this re-enables buttons appropriately
                        return;
                    }

                    const now = Date.now();
                    const totalRestMillis = currentTotalRestSeconds * 1000;
                    const endTime = now + totalRestMillis;

                    // Check SW controller *before* posting message
                    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                         console.log('Main Script: SW controller found. Sending SCHEDULE_REST_END message to SW.', { type: 'SCHEDULE_REST_END', endTime: endTime }); // *** DEBUG Log sending ***
                         try {
                              navigator.serviceWorker.controller.postMessage({ type: 'SCHEDULE_REST_END', endTime: endTime });
                              showUserFeedback(activeWorkoutFeedback, feedbackMessage + "Starting rest...", "success");
                         } catch (postMessageError) {
                             console.error("Main Script: Error sending message to SW:", postMessageError); // *** DEBUG Log postMessage error ***
                             showUserFeedback(activeWorkoutFeedback, feedbackMessage + "Error starting timer.", "error");
                         }
                    } else {
                         console.warn("Main Script: SW controller not available. Cannot schedule background timer."); // *** DEBUG Log missing controller ***
                         showUserFeedback(activeWorkoutFeedback, feedbackMessage + "Starting rest (background timer may fail)...", "warning");
                         // If SW fails, you might still want the visual timer
                    }

                    remainingSecondsForCountdown = currentTotalRestSeconds;
                    startRestTimerVisuals(); // This function handles the UI timer
                    console.log("Main Script: handleLogSet finished."); // *** DEBUG Log end ***
                }


                // --- Settings Modal Logic (Add Notification Button Logic) ---
                function openSettingsModal() {
                    if(settingsModal && settingsTimerMinutesInput && settingsTimerSecondsInput) {
                        settingsTimerMinutesInput.value = defaultRestMinutes;
                        settingsTimerSecondsInput.value = defaultRestSeconds;
                        updateNotificationStatusDisplay(); // Update status when opening
                        settingsModal.classList.remove('truly-hidden');
                        settingsModal.classList.add('visible');
                    } else {
                        console.error("openSettingsModal - Critical elements not found!");
                    }
                 }
                function closeSettingsModal() { /* Keep as is */ }
                function saveTimerSettings() { /* Keep as is */ }
                function loadTimerSettings() { /* Keep as is */ }
                function handleShowResetConfirmation() { /* Keep as is */ }
                function handleCancelReset() { /* Keep as is */ }
                function handleConfirmReset() { /* Keep as is */ }
                function exportAllData() { /* Keep as is */ }
                function handleImportData() { /* Keep as is */ }

                // --- Body Weight Logging (Keep as is) ---
                function logBodyWeight(event) { /* Keep as is */ }

                // --- View Toggle Logic (Keep as is) ---
                function toggleView(showSection) { /* Keep as is */ }
                function displayCurrentDayInfo() { /* Keep as is */ }

                // --- Login Logic (Keep as is) ---
                function attemptLogin() { /* Keep as is */ }

                // --- Initialize App (Add Notification Status Update) ---
                function initializeApp() {
                    console.log("initializeApp: Function Started.");
                    try {
                        loadTimerSettings();
                        renderLoggedWorkoutsAccordion();
                        renderProgress();
                        setDefaultDate(activeWorkoutDateInput);
                        setDefaultDate(bodyWeightDateEl);
                        renderBodyWeightLog();
                        renderWorkoutRoutines();
                        displayCurrentDayInfo();
                        toggleView('routines');
                        updateNotificationStatusDisplay(); // Update status on initial load

                        if (activeUnitInput && activeUnitDisplayValue) { activeUnitInput.addEventListener('change', function() { if(activeUnitDisplayValue) activeUnitDisplayValue.textContent = this.value; if (activeWorkoutState) { activeWorkoutState.unit = this.value; } }); if(activeUnitDisplayValue) activeUnitDisplayValue.textContent = activeUnitInput.value; }
                        if (togglePBsBtn && personalBestsListEl) setupAccordionToggle(togglePBsBtn, personalBestsListEl);
                        if (toggleMuscleFocusBtn && muscleGroupPbsListEl) setupAccordionToggle(toggleMuscleFocusBtn, muscleGroupPbsListEl);
                        if(document.getElementById('currentYear')) document.getElementById('currentYear').textContent = new Date().getFullYear();
                    } catch (initError) { console.error("initializeApp: ERROR during initialization steps:", initError); }
                    console.log("initializeApp: Function Finished.");
                }

                // ========================================================
                // --- Event Listeners (Add Notification Button) ---
                // ========================================================
                if (loginButton) loginButton.addEventListener('click', attemptLogin);
                if (passwordInput) passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') attemptLogin(); });
                if (settingsCogButton) settingsCogButton.addEventListener('click', openSettingsModal);
                if(logSetButton) logSetButton.addEventListener('click', handleLogSet);
                if(finishExerciseButton) finishExerciseButton.addEventListener('click', handleFinishExercise);
                if(closeSettingsModalBtn) closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
                if(saveTimerSettingsBtn) saveTimerSettingsBtn.addEventListener('click', saveTimerSettings);
                if(requestNotificationPermissionBtn) requestNotificationPermissionBtn.addEventListener('click', requestNotificationPermission); // Added Listener
                if(showResetConfirmationBtn) showResetConfirmationBtn.addEventListener('click', handleShowResetConfirmation);
                if(confirmResetBtn) confirmResetBtn.addEventListener('click', handleConfirmReset);
                if(cancelResetBtn) cancelResetBtn.addEventListener('click', handleCancelReset);
                if(exportDataBtn) exportDataBtn.addEventListener('click', exportAllData);
                if(importDataBtn) importDataBtn.addEventListener('click', handleImportData);
                if(showCancelDayConfirmationBtn) showCancelDayConfirmationBtn.addEventListener('click', showCancelDayConfirmation);
                if(confirmCancelDayBtn) confirmCancelDayBtn.addEventListener('click', confirmCancelDayAction);
                if(dontCancelDayBtn) dontCancelDayBtn.addEventListener('click', hideCancelDayConfirmation);
                if(bodyWeightForm) bodyWeightForm.addEventListener('submit', logBodyWeight);
                if(okSummaryModalBtn) okSummaryModalBtn.addEventListener('click', () => { if(workoutSummaryModal) { workoutSummaryModal.classList.remove('visible'); setTimeout(() => workoutSummaryModal.classList.add('truly-hidden'), 300); } });
                if(closeSummaryModalBtn) closeSummaryModalBtn.addEventListener('click', () => { if(workoutSummaryModal) { workoutSummaryModal.classList.remove('visible'); setTimeout(() => workoutSummaryModal.classList.add('truly-hidden'), 300); } });
                if(fullscreenPauseResumeBtn) fullscreenPauseResumeBtn.addEventListener('click', () => { if (restTimerState === 'running') pauseRestTimer(); else if (restTimerState === 'paused') resumeRestTimer(); });
                if(fullscreenAdd15sBtn) fullscreenAdd15sBtn.addEventListener('click', add15SecondsToRest);
                if(fullscreenStopBtn) fullscreenStopBtn.addEventListener('click', () => stopAndHideRestTimer(true));
                if(fullscreenMinimizeBtn) fullscreenMinimizeBtn.addEventListener('click', handleMinimizeTimer);
                if(minimizedPauseResumeBtn) minimizedPauseResumeBtn.addEventListener('click', () => { if (restTimerState === 'running') pauseRestTimer(); else if (restTimerState === 'paused') resumeRestTimer(); });
                if(minimizedAdd15sBtn) minimizedAdd15sBtn.addEventListener('click', add15SecondsToRest);
                if(minimizedStopBtn) minimizedStopBtn.addEventListener('click', () => stopAndHideRestTimer(true));
                if(minimizedMaximizeBtn) minimizedMaximizeBtn.addEventListener('click', handleMaximizeTimer);
                if(showRoutinesBtn) showRoutinesBtn.addEventListener('click', () => toggleView('routines'));
                if(showLogBtn) showLogBtn.addEventListener('click', () => toggleView('log'));
                if(showCalendarBtn) showCalendarBtn.addEventListener('click', () => toggleView('calendar'));
                if(showBodyWeightBtn) showBodyWeightBtn.addEventListener('click', () => toggleView('bodyweight'));
                if(progressBtn) progressBtn.addEventListener('click', () => toggleView('progress'));

                // --- Initial Setup Logic (Keep as is) ---
                if (!loginScreen || !appContainer) { console.error("Critical DOM elements missing."); return; }
                if (sessionStorage.getItem('isFitTrackLoggedIn') === 'true') { loginScreen.classList.add('truly-hidden'); appContainer.classList.remove('truly-hidden'); initializeApp(); }
                else { appContainer.classList.add('truly-hidden'); loginScreen.classList.remove('truly-hidden'); if(passwordInput) passwordInput.focus(); }

                // --- Service Worker Registration (Use relative path, add logging) ---
                if ('serviceWorker' in navigator) {
                     window.addEventListener('load', () => {
                        // Use relative path for SW registration for GH Pages compatibility
                        navigator.serviceWorker.register('service-worker.js')
                           .then(reg => {
                               console.log('Main Script: SW registered successfully. Scope:', reg.scope); // *** DEBUG Log success ***
                               reg.addEventListener('updatefound', () => {
                                  const newWorker = reg.installing;
                                  console.log('Main Script: SW Update Found', newWorker);
                                  newWorker.addEventListener('statechange', () => {
                                       console.log('Main Script: SW State Change:', newWorker.state);
                                  });
                               });
                           })
                           .catch(err => {
                               console.error('Main Script: SW registration failed: ', err); // *** DEBUG Log failure ***
                           });
                         navigator.serviceWorker.addEventListener('controllerchange', () => {
                            console.log('Main Script: SW Controller Changed - new SW activated.');
                         });
                     });
                } else {
                     console.log('Main Script: Service Worker not supported in this browser.');
                     // Optionally show feedback that offline/background features are disabled
                     showUserFeedback(appHeader || document.body, "Offline/Background features disabled (Browser unsupported).", "warning", 0);
                }

            }); // End DOMContentLoaded

        } catch (globalError) {
             console.error("Global script error:", globalError);
             // Fallback display if script completely fails
             document.body.innerHTML = "<p style='color:red;font-family:sans-serif;padding:20px;'>A critical error occurred loading FitTrack script. Please check the console.</p>";
        }
    </script>
</body>
</html>
